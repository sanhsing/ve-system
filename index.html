<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VE-System è™›æ“¾åœ°çƒç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body{font-family:system-ui,-apple-system,sans-serif}
        .gradient-bg{background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%)}
        .spin{animation:spin 1s linear infinite}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .shake{animation:shake .5s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .bounce{animation:bounce .5s}
        @keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .fade{animation:fade .3s}
        @keyframes fade{from{opacity:0}to{opacity:1}}
        .card{background:rgba(30,41,59,.7);backdrop-filter:blur(10px)}
        .bar{transition:width .3s}
        .glow{box-shadow:0 0 20px rgba(59,130,246,.5)}
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect}=React;
const API='https://ve-system.onrender.com';

// é€šç”¨
const Loading=()=><div className="flex justify-center p-8"><div className="spin text-4xl">âš™ï¸</div></div>;
const Modal=({open,onClose,title,children,wide})=>{
    if(!open)return null;
    return(<div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={onClose}>
        <div className={`card rounded-2xl ${wide?'max-w-5xl':'max-w-2xl'} w-full max-h-[90vh] overflow-hidden border border-slate-500 fade relative`} onClick={e=>e.stopPropagation()}>
            <div className="p-4 border-b border-slate-600 flex justify-between items-center bg-slate-800">
                <h2 className="text-xl font-bold pr-12">{title}</h2>
                <button onClick={onClose} className="absolute top-3 right-3 w-10 h-10 bg-red-600 hover:bg-red-500 rounded-full flex items-center justify-center text-2xl font-bold transition" title="é—œé–‰">âœ•</button>
            </div>
            <div className="p-5 overflow-y-auto" style={{maxHeight:'calc(90vh - 140px)'}}>{children}</div>
            <div className="p-4 border-t border-slate-600 bg-slate-800">
                <button onClick={onClose} className="w-full py-3 bg-slate-600 hover:bg-slate-500 rounded-lg font-semibold transition">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>);
};
const Tab=({tabs,active,set})=>(
    <div className="flex gap-2 flex-wrap mb-4">
        {tabs.map(t=><button key={t.id} onClick={()=>set(t.id)} className={`px-4 py-2 rounded-lg text-sm ${active===t.id?'bg-blue-600':'bg-slate-700 hover:bg-slate-600'}`}>{t.icon} {t.name}</button>)}
    </div>
);
const Stat=({icon,value,label,color})=>(
    <div className="text-center">
        <div className={`text-2xl font-bold ${color||'text-white'}`}>{icon} {value}</div>
        <div className="text-xs text-slate-400">{label}</div>
    </div>
);

// å°èˆª
const Nav=({page,setPage})=>(
    <nav className="bg-slate-900/80 backdrop-blur border-b border-slate-700 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setPage('home')}>
                <span className="text-2xl">ğŸŒŒ</span>
                <span className="font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">VE-System</span>
            </div>
            <div className="flex gap-1">
                {[{id:'home',i:'ğŸ ',n:'é¦–é '},{id:'edu',i:'ğŸ“š',n:'æ•™è‚²'},{id:'game',i:'ğŸ®',n:'éŠæˆ²'}].map(x=>
                    <button key={x.id} onClick={()=>setPage(x.id)} className={`px-3 py-1.5 rounded-lg text-sm ${page===x.id?'bg-blue-600':'hover:bg-slate-700'}`}>{x.i}<span className="hidden sm:inline ml-1">{x.n}</span></button>
                )}
            </div>
        </div>
    </nav>
);

// é¦–é 
const Home=({setPage})=>(
    <div className="space-y-6">
        <div className="text-center py-8">
            <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">è™›æ“¾åœ°çƒç³»çµ±</h1>
            <p className="text-slate-400 mt-2">E18K é˜²è©æ•™è‚²éŠæˆ²å¹³å°</p>
        </div>
        <div className="grid md:grid-cols-2 gap-6">
            <div onClick={()=>setPage('edu')} className="card rounded-xl p-6 border border-slate-700 cursor-pointer hover:border-blue-500 glow transition">
                <div className="text-5xl mb-4">ğŸ“š</div>
                <h2 className="text-xl font-bold">æ•™è‚²ç³»çµ±</h2>
                <p className="text-slate-400 text-sm mt-2">108èª²ç¶± Â· AIèªè­‰ Â· çŸ¥è­˜ç¯€é» Â· è¡“èªåº«</p>
                <div className="mt-3 grid grid-cols-4 gap-2 text-center text-xs">
                    <div><div className="text-blue-400 font-bold">546</div>é¡Œåº«</div>
                    <div><div className="text-purple-400 font-bold">103</div>æ¦‚å¿µ</div>
                    <div><div className="text-green-400 font-bold">96</div>è¡“èª</div>
                    <div><div className="text-yellow-400 font-bold">35</div>å¾½ç« </div>
                </div>
            </div>
            <div onClick={()=>setPage('game')} className="card rounded-xl p-6 border border-slate-700 cursor-pointer hover:border-green-500 glow transition">
                <div className="text-5xl mb-4">ğŸ®</div>
                <h2 className="text-xl font-bold">E18K éŠæˆ²</h2>
                <p className="text-slate-400 text-sm mt-2">æ€ªç‰©æ”¶é›† Â· BOSSæˆ° Â· è©é¨™é˜²ç¦¦ Â· PVPå°æˆ°</p>
                <div className="mt-3 grid grid-cols-4 gap-2 text-center text-xs">
                    <div><div className="text-red-400 font-bold">470</div>æ€ªç‰©</div>
                    <div><div className="text-orange-400 font-bold">500+</div>æŠ€èƒ½</div>
                    <div><div className="text-cyan-400 font-bold">100+</div>è©é¨™æ¡ˆä¾‹</div>
                    <div><div className="text-pink-400 font-bold">5</div>BOSS</div>
                </div>
            </div>
        </div>
    </div>
);

// ========== æ•™è‚²ç³»çµ± ==========
const Education=()=>{
    const [tab,setTab]=useState('quiz');
    const [data,setData]=useState({subjects:[],concepts:[],conceptLinks:[],knowledge:[],glossary:[],badges:[],achievements:[],questions:[],aiModules:[],aiLessons:[],curriculum108:{competencies:[],domains:[],stages:[],issues:[]}});
    const [loading,setLoading]=useState(true);
    const [selected,setSelected]=useState(null);
    const [modal,setModal]=useState(null);
    
    // æ¸¬é©—ç‹€æ…‹
    const [quizMode,setQuizMode]=useState('menu');
    const [quizQs,setQuizQs]=useState([]);
    const [qIdx,setQIdx]=useState(0);
    const [answer,setAnswer]=useState(null);
    const [result,setResult]=useState(null);
    const [score,setScore]=useState({c:0,t:0,streak:0,max:0});
    const [timer,setTimer]=useState(30);
    const [timerOn,setTimerOn]=useState(false);
    const [quizSubj,setQuizSubj]=useState('all');
    const [quizType,setQuizType]=useState('exam');

    useEffect(()=>{
        setLoading(true);
        Promise.all([
            fetch(`${API}/api/v1/db/education/table/subjects?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/concepts?limit=150`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/concept_links?limit=100`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/subject_knowledge_detailed?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/ai_cert_glossary?limit=100`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/badges?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/achievements?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/ai_cert_modules?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/ai_cert_lessons?limit=30`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/curriculum_108_competencies?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/curriculum_108_domains?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/curriculum_108_stages?limit=10`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/education/table/curriculum_108_issues?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
        ]).then(([subj,conc,links,know,gloss,bdg,ach,mod,les,comp,dom,stg,iss])=>{
            setData({
                subjects:subj.data||[],concepts:conc.data||[],conceptLinks:links.data||[],
                knowledge:know.data||[],glossary:gloss.data||[],badges:bdg.data||[],
                achievements:ach.data||[],aiModules:mod.data||[],aiLessons:les.data||[],
                curriculum108:{competencies:comp.data||[],domains:dom.data||[],stages:stg.data||[],issues:iss.data||[]}
            });
            setLoading(false);
        });
    },[]);

    // è¨ˆæ™‚å™¨
    useEffect(()=>{
        if(timerOn&&timer>0){const t=setTimeout(()=>setTimer(v=>v-1),1000);return()=>clearTimeout(t);}
        else if(timer===0&&timerOn){setTimerOn(false);setResult({correct:false,timeout:true,correct_answer:quizQs[qIdx]?.answer});setScore(p=>({...p,t:p.t+1,streak:0}));}
    },[timer,timerOn]);

    const icons={chinese:'ğŸ“–',english:'ğŸ”¤',math:'ğŸ”¢',physics:'âš›ï¸',chemistry:'ğŸ§ª',biology:'ğŸ§¬',earth_science:'ğŸŒ',history:'ğŸ“œ',geography:'ğŸ—ºï¸',civics:'âš–ï¸'};
    const getRelations=(id)=>({
        pre:data.conceptLinks.filter(l=>l.target_id===id).map(l=>data.concepts.find(c=>c.id===l.source_id)).filter(Boolean),
        post:data.conceptLinks.filter(l=>l.source_id===id).map(l=>data.concepts.find(c=>c.id===l.target_id)).filter(Boolean)
    });

    const loadQuiz=async()=>{
        try{
            const table=quizType==='ai'?'ai_cert_questions':'exam_questions';
            const url=quizSubj==='all'?`${API}/api/v1/education/questions?limit=10`:`${API}/api/v1/education/questions?limit=10&subject=${quizSubj}`;
            const res=await fetch(url);
            const d=await res.json();
            if(d.questions?.length>0){setQuizQs(d.questions);setQIdx(0);setScore({c:0,t:0,streak:0,max:0});setAnswer(null);setResult(null);setQuizMode('quiz');setTimer(30);setTimerOn(true);}
            else alert('æ²’æœ‰é¡Œç›®');
        }catch(e){alert('è¼‰å…¥å¤±æ•—');}
    };
    const checkAns=async(ans)=>{
        if(result)return;setAnswer(ans);setTimerOn(false);
        try{
            const res=await fetch(`${API}/api/v1/education/check`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question_id:quizQs[qIdx].question_id,answer:ans})});
            const d=await res.json();setResult(d);
            const ns=d.correct?score.streak+1:0;
            setScore(p=>({c:p.c+(d.correct?1:0),t:p.t+1,streak:ns,max:Math.max(p.max,ns)}));
        }catch(e){}
    };
    const nextQ=()=>{if(qIdx<quizQs.length-1){setQIdx(p=>p+1);setAnswer(null);setResult(null);setTimer(30);setTimerOn(true);}else setQuizMode('result');};

    if(loading)return<Loading/>;

    const tabs=[
        {id:'quiz',icon:'ğŸ¯',name:'æ¸¬é©—'},
        {id:'108',icon:'ğŸ“–',name:'108èª²ç¶±'},
        {id:'concepts',icon:'ğŸ§©',name:'çŸ¥è­˜ç¯€é»'},
        {id:'knowledge',icon:'ğŸ“',name:'è©³è§£å£è¨£'},
        {id:'mindmap',icon:'ğŸ§ ',name:'å¿ƒæ™ºåœ–'},
        {id:'ai',icon:'ğŸ¤–',name:'AIèªè­‰'},
        {id:'glossary',icon:'ğŸ“–',name:'è¡“èªåº«'},
        {id:'badges',icon:'ğŸ–ï¸',name:'å¾½ç« æˆå°±'},
    ];

    // æ¸¬é©—
    const Quiz=()=>{
        if(quizMode==='quiz'){
            const q=quizQs[qIdx];if(!q)return<Loading/>;
            const opts=Array.isArray(q.options)?q.options:[];
            return(
                <div className="max-w-3xl mx-auto space-y-4">
                    <div className="flex justify-between items-center">
                        <button onClick={()=>{setQuizMode('menu');setTimerOn(false);}} className="text-slate-400 hover:text-white">â† è¿”å›</button>
                        <div className="flex items-center gap-4">
                            {score.streak>=3&&<span className="text-orange-400 bounce">ğŸ”¥{score.streak}</span>}
                            <span className="text-green-400 font-bold">{score.c}/{score.t}</span>
                        </div>
                    </div>
                    <div className="card rounded-xl p-6 border border-slate-700">
                        <div className="flex justify-between text-sm text-slate-400 mb-2">
                            <span>é¡Œç›® {qIdx+1}/{quizQs.length}</span>
                            <span className={timer<=10?'text-red-400 font-bold':''}>{timer}s</span>
                        </div>
                        <div className="h-1.5 bg-slate-700 rounded-full mb-4"><div className={`h-1.5 rounded-full bar ${timer<=10?'bg-red-500':'bg-green-500'}`} style={{width:`${timer/30*100}%`}}></div></div>
                        <div className="mb-2"><span className="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded">{q.subject||q.subject_id}</span></div>
                        <h2 className="text-lg mb-6">{q.question_text}</h2>
                        <div className="space-y-2">
                            {opts.map((opt,i)=>{
                                const l=opt.charAt(0),sel=answer===l,cor=result?.correct_answer===l,wrong=sel&&!result?.correct;
                                let cls='border-slate-600 hover:border-blue-500';
                                if(result){if(cor)cls='border-green-500 bg-green-900/30 bounce';else if(wrong)cls='border-red-500 bg-red-900/30 shake';else cls='border-slate-700 opacity-50';}
                                return<button key={i} onClick={()=>checkAns(l)} disabled={!!result} className={`w-full text-left p-3 rounded-lg border-2 transition ${cls}`}><span className="font-bold mr-2">{l}.</span>{opt.substring(2)}</button>;
                            })}
                        </div>
                        {result&&<div className={`mt-4 p-4 rounded-lg fade ${result.correct?'bg-green-900/30 border border-green-600':'bg-red-900/30 border border-red-600'}`}>
                            <div className="font-bold">{result.timeout?'â° æ™‚é–“åˆ°ï¼':result.correct?'âœ… ç­”å°äº†ï¼':'âŒ ç­”éŒ¯äº†'}{!result.correct&&<span className="ml-2 text-green-400">æ­£ç¢º: {result.correct_answer}</span>}</div>
                            {q.explanation&&<p className="text-slate-300 text-sm mt-2">{q.explanation}</p>}
                        </div>}
                        {result&&<button onClick={nextQ} className="w-full py-3 bg-blue-600 rounded-lg font-semibold mt-4">{qIdx<quizQs.length-1?'ä¸‹ä¸€é¡Œ â†’':'æŸ¥çœ‹çµæœ ğŸ†'}</button>}
                    </div>
                </div>
            );
        }
        if(quizMode==='result'){
            const pct=Math.round(score.c/score.t*100),grade=pct>=90?'S':pct>=80?'A':pct>=70?'B':pct>=60?'C':'D';
            const colors={S:'text-yellow-400',A:'text-green-400',B:'text-blue-400',C:'text-orange-400',D:'text-red-400'};
            return(
                <div className="max-w-md mx-auto card rounded-xl p-8 border border-slate-700 text-center">
                    <div className="text-5xl mb-4">ğŸ‰</div><h2 className="text-2xl font-bold">æŒ‘æˆ°å®Œæˆï¼</h2>
                    <div className={`text-8xl font-bold my-6 ${colors[grade]}`}>{grade}</div>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold text-green-400">{score.c}</div><div className="text-xs text-slate-500">ç­”å°</div></div>
                        <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold">{pct}%</div><div className="text-xs text-slate-500">æ­£ç¢ºç‡</div></div>
                        <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold text-orange-400">{score.max}</div><div className="text-xs text-slate-500">é€£å‹</div></div>
                    </div>
                    <div className="flex gap-3"><button onClick={()=>setQuizMode('menu')} className="flex-1 py-2 bg-slate-700 rounded-lg">è¿”å›</button><button onClick={loadQuiz} className="flex-1 py-2 bg-blue-600 rounded-lg">å†ç©</button></div>
                </div>
            );
        }
        return(
            <div className="space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                    <div className="card rounded-xl p-6 border border-slate-700">
                        <h4 className="font-semibold mb-4">ğŸ“š é¸æ“‡ç§‘ç›®</h4>
                        <div className="grid grid-cols-3 gap-2">
                            {['all','æ•¸å­¸','åœ‹æ–‡','è‹±æ–‡','è‡ªç„¶','ç¤¾æœƒ'].map(s=><button key={s} onClick={()=>setQuizSubj(s)} className={`p-2 rounded-lg text-sm ${quizSubj===s?'bg-blue-600':'bg-slate-700'}`}>{s==='all'?'å…¨éƒ¨':s}</button>)}
                        </div>
                    </div>
                    <div className="card rounded-xl p-6 border border-slate-700">
                        <h4 className="font-semibold mb-4">ğŸ“‹ é¡Œåº«ä¾†æº</h4>
                        <div className="flex gap-2 mb-4">
                            <button onClick={()=>setQuizType('exam')} className={`flex-1 p-2 rounded-lg ${quizType==='exam'?'bg-green-600':'bg-slate-700'}`}>ğŸ“ 108èª²ç¶± (107é¡Œ)</button>
                            <button onClick={()=>setQuizType('ai')} className={`flex-1 p-2 rounded-lg ${quizType==='ai'?'bg-green-600':'bg-slate-700'}`}>ğŸ¤– AIèªè­‰ (339é¡Œ)</button>
                        </div>
                        <button onClick={loadQuiz} className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg font-bold">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
                    </div>
                </div>
                <div className="card rounded-xl p-4 border border-slate-700">
                    <h4 className="font-semibold mb-3">ğŸ“Š é¡Œåº«çµ±è¨ˆ</h4>
                    <div className="grid grid-cols-4 gap-4 text-center">
                        <div><div className="text-2xl font-bold text-blue-400">107</div><div className="text-xs text-slate-500">108èª²ç¶±é¡Œ</div></div>
                        <div><div className="text-2xl font-bold text-purple-400">339</div><div className="text-xs text-slate-500">AIèªè­‰é¡Œ</div></div>
                        <div><div className="text-2xl font-bold text-green-400">100</div><div className="text-xs text-slate-500">ç·´ç¿’é¡Œ</div></div>
                        <div><div className="text-2xl font-bold text-yellow-400">546</div><div className="text-xs text-slate-500">ç¸½é¡Œæ•¸</div></div>
                    </div>
                </div>
            </div>
        );
    };

    // 108èª²ç¶±
    const Curriculum108=()=>(
        <div className="space-y-6">
            <div className="grid md:grid-cols-5 gap-3">
                {data.subjects.map((s,i)=>(
                    <div key={i} onClick={()=>setSelected({type:'subject',data:s})} className="card rounded-xl p-4 border border-slate-700 cursor-pointer hover:border-blue-500 text-center">
                        <div className="text-3xl mb-2">{icons[s.code]||'ğŸ“˜'}</div>
                        <div className="font-bold">{s.name}</div>
                        <div className="text-xs text-slate-400">{data.concepts.filter(c=>c.subject_code===s.code).length} æ¦‚å¿µ</div>
                    </div>
                ))}
            </div>
            <h4 className="font-semibold">ğŸ¯ æ ¸å¿ƒç´ é¤Š ({data.curriculum108.competencies.length})</h4>
            <div className="grid md:grid-cols-3 gap-3">
                {data.curriculum108.competencies.map((c,i)=>(
                    <div key={i} className="card rounded-lg p-3 border border-slate-700">
                        <div className="flex items-center gap-2 mb-2">
                            <span className={`px-2 py-0.5 rounded text-xs ${c.dimension_code==='A'?'bg-red-900/50 text-red-400':c.dimension_code==='B'?'bg-blue-900/50 text-blue-400':'bg-green-900/50 text-green-400'}`}>{c.competency_code}</span>
                            <span className="font-bold text-sm">{c.competency_name}</span>
                        </div>
                        <p className="text-xs text-slate-400 line-clamp-2">{c.description}</p>
                        {c.e18k_mapping&&<div className="mt-2 text-xs text-purple-400">ğŸ® {c.e18k_mapping}</div>}
                    </div>
                ))}
            </div>
            <div className="grid md:grid-cols-2 gap-6">
                <div>
                    <h4 className="font-semibold mb-3">ğŸ“– å­¸ç¿’é ˜åŸŸ ({data.curriculum108.domains.length})</h4>
                    <div className="space-y-2">
                        {data.curriculum108.domains.map((d,i)=>(
                            <div key={i} className="card rounded-lg p-3 border border-slate-700">
                                <div className="font-bold text-blue-400">{d.domain_name}</div>
                                <div className="text-xs text-slate-400">{d.subjects}</div>
                            </div>
                        ))}
                    </div>
                </div>
                <div>
                    <h4 className="font-semibold mb-3">ğŸŒ± å­¸ç¿’éšæ®µ ({data.curriculum108.stages.length})</h4>
                    <div className="space-y-2">
                        {data.curriculum108.stages.map((s,i)=>(
                            <div key={i} className="card rounded-lg p-3 border border-slate-700">
                                <div className="font-bold text-green-400">{s.stage_name}</div>
                                <div className="text-xs text-slate-400">{s.description}</div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
            <h4 className="font-semibold">ğŸ”¥ è­°é¡Œèå…¥ ({data.curriculum108.issues.length})</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                {data.curriculum108.issues.map((is,i)=>(
                    <div key={i} className="card rounded-lg p-2 border border-slate-700 text-center">
                        <div className="text-sm font-bold text-yellow-400">{is.issue_name}</div>
                    </div>
                ))}
            </div>
        </div>
    );

    // çŸ¥è­˜ç¯€é»
    const Concepts=()=>{
        const filtered=selected?.type==='subject'?data.concepts.filter(c=>c.subject_code===selected.data.code):data.concepts;
        return(
            <div className="space-y-4">
                {selected?.type==='subject'&&<button onClick={()=>setSelected(null)} className="text-slate-400 hover:text-white">â† è¿”å›å…¨éƒ¨ ({data.concepts.length})</button>}
                <div className="flex flex-wrap gap-2 mb-4">
                    {data.subjects.map(s=><button key={s.code} onClick={()=>setSelected({type:'subject',data:s})} className={`px-3 py-1 rounded-lg text-sm ${selected?.data?.code===s.code?'bg-blue-600':'bg-slate-700'}`}>{icons[s.code]} {s.name}</button>)}
                </div>
                <div className="grid md:grid-cols-2 gap-3">
                    {filtered.slice(0,20).map((c,i)=>{
                        const rel=getRelations(c.id);
                        return(
                            <div key={i} onClick={()=>setModal({type:'concept',data:c,rel})} className="card rounded-lg p-4 border-l-4 border-blue-500 cursor-pointer hover:border-blue-400">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-blue-400">{c.title}</h4>
                                    <span className="text-xs px-2 py-0.5 bg-slate-700 rounded">é›£åº¦{c.difficulty}</span>
                                </div>
                                <p className="text-sm text-slate-300 line-clamp-2">{c.content}</p>
                                {c.keywords&&<div className="mt-2 flex flex-wrap gap-1">{JSON.parse(c.keywords||'[]').slice(0,3).map((k,j)=><span key={j} className="text-xs px-2 py-0.5 bg-blue-900/30 text-blue-400 rounded">{k}</span>)}</div>}
                                <div className="mt-2 flex gap-3 text-xs text-slate-500">
                                    {rel.pre.length>0&&<span>â¬…ï¸{rel.pre.length}å‰ç½®</span>}
                                    {rel.post.length>0&&<span>â¡ï¸{rel.post.length}è¡ç”Ÿ</span>}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    // è©³è§£å£è¨£
    const Knowledge=()=>(
        <div className="space-y-4">
            <p className="text-sm text-slate-400">å«è©³ç´°è§£é‡‹ã€ç¯„ä¾‹ã€è¨˜æ†¶å£è¨£ã€å¸¸è¦‹éŒ¯èª¤ ({data.knowledge.length})</p>
            <div className="space-y-3">
                {data.knowledge.map((k,i)=>(
                    <div key={i} onClick={()=>setModal({type:'knowledge',data:k})} className="card rounded-xl p-4 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <div className="flex justify-between items-start">
                            <div><span className="text-xs px-2 py-0.5 bg-blue-900/50 text-blue-400 rounded mr-2">{k.subject_name}</span><span className="text-xs text-slate-500">{k.chapter}</span></div>
                            <span className={`text-xs px-2 py-0.5 rounded ${k.difficulty<=2?'bg-green-900/50 text-green-400':k.difficulty<=3?'bg-yellow-900/50 text-yellow-400':'bg-red-900/50 text-red-400'}`}>é›£åº¦{k.difficulty}</span>
                        </div>
                        <h4 className="font-bold text-lg mt-2">{k.topic}</h4>
                        <p className="text-sm text-slate-300 mt-1 line-clamp-2">{k.content}</p>
                        <div className="mt-2 flex flex-wrap gap-2">
                            {k.detailed_explanation&&<span className="text-xs px-2 py-1 bg-purple-900/30 text-purple-400 rounded">ğŸ“–è©³è§£</span>}
                            {k.examples&&<span className="text-xs px-2 py-1 bg-green-900/30 text-green-400 rounded">ğŸ“ç¯„ä¾‹</span>}
                            {k.mnemonics&&<span className="text-xs px-2 py-1 bg-yellow-900/30 text-yellow-400 rounded">ğŸ’¡å£è¨£</span>}
                            {k.common_mistakes&&<span className="text-xs px-2 py-1 bg-red-900/30 text-red-400 rounded">âš ï¸å¸¸éŒ¯</span>}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // å¿ƒæ™ºåœ–
    const MindMap=()=>{
        const [center,setCenter]=useState(data.concepts.find(c=>data.conceptLinks.some(l=>l.source_id===c.id||l.target_id===c.id)));
        if(!center)return<div className="text-center py-8 text-slate-400">è¼‰å…¥ä¸­...</div>;
        const rel=getRelations(center.id);
        return(
            <div className="space-y-4">
                <div className="flex flex-wrap gap-2">{data.concepts.filter(c=>data.conceptLinks.some(l=>l.source_id===c.id||l.target_id===c.id)).slice(0,12).map((c,i)=><button key={i} onClick={()=>setCenter(c)} className={`px-3 py-1 rounded-lg text-sm ${center?.id===c.id?'bg-blue-600':'bg-slate-700'}`}>{c.title}</button>)}</div>
                <div className="card rounded-xl p-6 border border-slate-700">
                    <div className="grid grid-cols-3 gap-4 items-center">
                        <div className="space-y-2">
                            <div className="text-center text-sm text-orange-400 mb-2">â¬…ï¸ å‰ç½®è§€å¿µ ({rel.pre.length})</div>
                            {rel.pre.length>0?rel.pre.map((p,i)=><div key={i} onClick={()=>setCenter(p)} className="card rounded-lg p-3 border border-orange-500/50 cursor-pointer hover:border-orange-400"><div className="font-bold text-sm text-orange-400">{p.title}</div></div>):<div className="text-center text-slate-500 text-sm">ç„¡</div>}
                        </div>
                        <div className="text-center">
                            <div className="card rounded-xl p-6 border-2 border-blue-500 bg-blue-900/20">
                                <div className="text-2xl mb-2">ğŸ“</div>
                                <div className="font-bold text-lg text-blue-400">{center.title}</div>
                                <div className="text-sm text-slate-300 mt-2 line-clamp-3">{center.content?.substring(0,80)}...</div>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <div className="text-center text-sm text-green-400 mb-2">è¡ç”Ÿè§€å¿µ â¡ï¸ ({rel.post.length})</div>
                            {rel.post.length>0?rel.post.map((p,i)=><div key={i} onClick={()=>setCenter(p)} className="card rounded-lg p-3 border border-green-500/50 cursor-pointer hover:border-green-400"><div className="font-bold text-sm text-green-400">{p.title}</div></div>):<div className="text-center text-slate-500 text-sm">ç„¡</div>}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // AIèªè­‰
    const AICert=()=>(
        <div className="space-y-6">
            <h4 className="font-semibold">ğŸ¤– AI èªè­‰èª²ç¨‹æ¨¡çµ„ ({data.aiModules.length})</h4>
            <div className="grid md:grid-cols-2 gap-4">
                {data.aiModules.map((m,i)=>(
                    <div key={i} onClick={()=>setModal({type:'aimodule',data:m})} className="card rounded-xl p-4 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <div className="flex justify-between items-start">
                            <h4 className="font-bold text-blue-400">{m.module_name_zh||m.module_name}</h4>
                            <span className="text-xs px-2 py-1 bg-slate-700 rounded">é›£åº¦{m.difficulty}</span>
                        </div>
                        <p className="text-sm text-slate-400 mt-2 line-clamp-2">{m.description}</p>
                        <div className="mt-3 flex justify-between items-center text-sm">
                            <span className="text-slate-500">â±ï¸{m.estimated_hours}h</span>
                            <span className="text-green-400">{data.aiLessons.filter(l=>l.module_id===m.module_id).length} èª²ç¨‹</span>
                        </div>
                    </div>
                ))}
            </div>
            <h4 className="font-semibold">ğŸ“š èª²ç¨‹åˆ—è¡¨ ({data.aiLessons.length})</h4>
            <div className="space-y-2">
                {data.aiLessons.slice(0,10).map((l,i)=>(
                    <div key={i} onClick={()=>setModal({type:'ailesson',data:l})} className="card rounded-lg p-3 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <div className="flex justify-between"><span className="font-bold text-blue-400">{l.lesson_name_zh||l.lesson_name}</span><span className="text-xs text-slate-500">â±ï¸{l.estimated_minutes}min</span></div>
                    </div>
                ))}
            </div>
        </div>
    );

    // è¡“èªåº«
    const Glossary=()=>(
        <div className="space-y-4">
            <p className="text-sm text-slate-400">AI èªè­‰ç›¸é—œè¡“èª ({data.glossary.length})</p>
            <div className="grid md:grid-cols-2 gap-3">
                {data.glossary.slice(0,20).map((g,i)=>(
                    <div key={i} onClick={()=>setModal({type:'glossary',data:g})} className="card rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <div className="flex justify-between items-start">
                            <div><span className="font-bold text-blue-400">{g.term_zh}</span><span className="text-slate-400 text-sm ml-2">{g.term_en}</span></div>
                            <span className="text-xs px-2 py-0.5 bg-slate-700 rounded">{g.category}</span>
                        </div>
                        <p className="text-sm text-slate-300 mt-2 line-clamp-2">{g.definition_zh}</p>
                    </div>
                ))}
            </div>
        </div>
    );

    // å¾½ç« æˆå°±
    const Badges=()=>(
        <div className="space-y-6">
            <h4 className="font-semibold">ğŸ–ï¸ å¾½ç«  ({data.badges.length})</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {data.badges.slice(0,16).map((b,i)=>(
                    <div key={i} className="card rounded-lg p-4 border border-slate-700 text-center">
                        <div className="text-4xl mb-2">{b.icon}</div>
                        <div className="font-bold text-sm">{b.name}</div>
                        <div className="text-xs text-slate-400 mt-1 line-clamp-2">{b.description}</div>
                        <div className="text-xs text-green-400 mt-1">+{b.xp_reward} XP</div>
                    </div>
                ))}
            </div>
            <h4 className="font-semibold">ğŸ† æˆå°± ({data.achievements.length})</h4>
            <div className="grid md:grid-cols-2 gap-3">
                {data.achievements.map((a,i)=>(
                    <div key={i} className="card rounded-lg p-3 border border-slate-700 flex items-center gap-3">
                        <div className="text-3xl">{a.badge_icon}</div>
                        <div><div className="font-bold">{a.name}</div><div className="text-xs text-slate-400">{a.description}</div><div className="text-xs text-yellow-400">+{a.points}é» Â· {a.rarity}</div></div>
                    </div>
                ))}
            </div>
        </div>
    );

    return(
        <div className="space-y-4">
            <h1 className="text-2xl font-bold">ğŸ“š æ•™è‚²ç³»çµ±</h1>
            <Tab tabs={tabs} active={tab} set={setTab}/>
            {tab==='quiz'&&<Quiz/>}
            {tab==='108'&&<Curriculum108/>}
            {tab==='concepts'&&<Concepts/>}
            {tab==='knowledge'&&<Knowledge/>}
            {tab==='mindmap'&&<MindMap/>}
            {tab==='ai'&&<AICert/>}
            {tab==='glossary'&&<Glossary/>}
            {tab==='badges'&&<Badges/>}
            
            {/* Modals */}
            <Modal open={modal?.type==='concept'} onClose={()=>setModal(null)} title={modal?.data?.title} wide>
                {modal?.data&&(
                    <div className="space-y-4">
                        <div className="flex flex-wrap gap-2">
                            <span className="px-2 py-1 bg-blue-900/50 text-blue-400 rounded text-sm">{modal.data.subject_code}</span>
                            <span className="px-2 py-1 bg-slate-700 rounded text-sm">Ch.{modal.data.chapter}</span>
                            <span className="px-2 py-1 bg-slate-700 rounded text-sm">é›£åº¦{modal.data.difficulty}</span>
                        </div>
                        <div className="card rounded-lg p-4 border border-slate-700"><h4 className="font-semibold mb-2">ğŸ“– å…§å®¹</h4><p className="text-slate-300 whitespace-pre-wrap">{modal.data.content}</p></div>
                        {modal.data.keywords&&<div><h4 className="font-semibold mb-2">ğŸ·ï¸ é—œéµå­—</h4><div className="flex flex-wrap gap-2">{JSON.parse(modal.data.keywords||'[]').map((k,i)=><span key={i} className="px-3 py-1 bg-blue-900/30 text-blue-400 rounded-full text-sm">{k}</span>)}</div></div>}
                        <div className="grid md:grid-cols-2 gap-4">
                            <div className="card rounded-lg p-4 border border-orange-500/30"><h4 className="font-semibold text-orange-400 mb-2">â¬…ï¸ å‰ç½®è§€å¿µ</h4>{modal.rel?.pre?.length>0?<div className="space-y-2">{modal.rel.pre.map((p,i)=><div key={i} className="text-sm p-2 bg-slate-800 rounded">{p.title}</div>)}</div>:<p className="text-slate-500 text-sm">ç„¡</p>}</div>
                            <div className="card rounded-lg p-4 border border-green-500/30"><h4 className="font-semibold text-green-400 mb-2">â¡ï¸ è¡ç”Ÿè§€å¿µ</h4>{modal.rel?.post?.length>0?<div className="space-y-2">{modal.rel.post.map((p,i)=><div key={i} className="text-sm p-2 bg-slate-800 rounded">{p.title}</div>)}</div>:<p className="text-slate-500 text-sm">ç„¡</p>}</div>
                        </div>
                    </div>
                )}
            </Modal>
            <Modal open={modal?.type==='knowledge'} onClose={()=>setModal(null)} title={modal?.data?.topic} wide>
                {modal?.data&&(
                    <div className="space-y-4">
                        {modal.data.detailed_explanation&&<div className="card rounded-lg p-4 border border-purple-500/30"><h4 className="font-semibold text-purple-400 mb-2">ğŸ“– è©³ç´°è§£é‡‹</h4><div className="text-slate-300 whitespace-pre-wrap text-sm">{modal.data.detailed_explanation}</div></div>}
                        {modal.data.examples&&<div className="card rounded-lg p-4 border border-green-500/30"><h4 className="font-semibold text-green-400 mb-2">ğŸ“ ç¯„ä¾‹</h4><div className="text-slate-300 whitespace-pre-wrap text-sm">{modal.data.examples}</div></div>}
                        {modal.data.mnemonics&&<div className="card rounded-lg p-4 border border-yellow-500/30"><h4 className="font-semibold text-yellow-400 mb-2">ğŸ’¡ è¨˜æ†¶å£è¨£</h4><div className="text-slate-300 text-lg">{modal.data.mnemonics}</div></div>}
                        {modal.data.common_mistakes&&<div className="card rounded-lg p-4 border border-red-500/30"><h4 className="font-semibold text-red-400 mb-2">âš ï¸ å¸¸è¦‹éŒ¯èª¤</h4><div className="text-slate-300 whitespace-pre-wrap text-sm">{modal.data.common_mistakes}</div></div>}
                    </div>
                )}
            </Modal>
            <Modal open={modal?.type==='ailesson'} onClose={()=>setModal(null)} title={modal?.data?.lesson_name_zh||modal?.data?.lesson_name} wide>
                {modal?.data&&<div className="prose prose-invert max-w-none"><div className="text-sm text-slate-400 mb-4">â±ï¸ {modal.data.estimated_minutes} åˆ†é˜</div><div className="whitespace-pre-wrap text-sm leading-relaxed">{modal.data.content}</div></div>}
            </Modal>
            <Modal open={modal?.type==='glossary'} onClose={()=>setModal(null)} title={`${modal?.data?.term_zh} (${modal?.data?.term_en})`}>
                {modal?.data&&(
                    <div className="space-y-4">
                        <div className="card rounded-lg p-4 border border-slate-700"><h4 className="font-semibold mb-2">ğŸ“– å®šç¾©</h4><p className="text-slate-300">{modal.data.definition_zh}</p><p className="text-slate-400 text-sm mt-2">{modal.data.definition}</p></div>
                        {modal.data.examples&&<div className="card rounded-lg p-4 border border-green-500/30"><h4 className="font-semibold text-green-400 mb-2">ğŸ“ ç¯„ä¾‹</h4><p className="text-slate-300">{modal.data.examples}</p></div>}
                    </div>
                )}
            </Modal>
        </div>
    );
};

// ========== éŠæˆ²ç³»çµ± ==========
const Game=()=>{
    const [tab,setTab]=useState('play');
    const [data,setData]=useState({creatures:[],skills:[],areas:[],bosses:[],npcs:[],quests:[],items:[],shopItems:[],scamCases:[],achievements:[],dialogues:[]});
    const [loading,setLoading]=useState(true);
    const [modal,setModal]=useState(null);
    const [player,setPlayer]=useState({hp:100,maxHp:100,gold:500,exp:0,level:1,completed:[]});
    const [currentQuest,setCurrentQuest]=useState(null);
    const [questResult,setQuestResult]=useState(null);

    useEffect(()=>{
        setLoading(true);
        Promise.all([
            fetch(`${API}/api/v1/db/ve/table/e18k_creatures_real?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_skills?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_areas?limit=20`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_bosses?limit=10`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_npcs?limit=30`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_quests?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_items?limit=100`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_shop_items?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_scam_cases?limit=100`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_achievements?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
            fetch(`${API}/api/v1/db/ve/table/e18k_dialogue_lines?limit=50`).then(r=>r.json()).catch(()=>({data:[]})),
        ]).then(([cre,ski,are,bos,npc,que,itm,shp,scm,ach,dlg])=>{
            setData({creatures:cre.data||[],skills:ski.data||[],areas:are.data||[],bosses:bos.data||[],npcs:npc.data||[],quests:que.data||[],items:itm.data||[],shopItems:shp.data||[],scamCases:scm.data||[],achievements:ach.data||[],dialogues:dlg.data||[]});
            setLoading(false);
        });
    },[]);

    const scenarios=[
        {id:'S001',title:'ç¥ç§˜æŠ•è³‡æ©Ÿæœƒ',diff:'ç°¡å–®',desc:'ä½ æ”¶åˆ°è¨Šæ¯ï¼šã€Œç¨å®¶å…§ç·šï¼ä¿è­‰å ±é…¬50%ï¼åªé™ä»Šå¤©ï¼ã€',options:[{id:'A',text:'ç«‹å³åŒ¯æ¬¾',correct:false,fb:'âŒã€Œä¿è­‰ç²åˆ©ã€æ˜¯æœ€å¤§è­¦è¨Šï¼'},{id:'B',text:'æŸ¥è­‰èº«ä»½',correct:true,fb:'âœ…æ­£ç¢ºï¼æ°¸é å…ˆæŸ¥è­‰ã€‚'}],exp:100,gold:50},
        {id:'S002',title:'å‡å†’éŠ€è¡Œ',diff:'ç°¡å–®',desc:'ã€Œæˆ‘æ˜¯éŠ€è¡Œé¢¨æ§ï¼Œå¸³æˆ¶ç•°å¸¸ï¼Œè«‹æä¾›å¯†ç¢¼é©—è­‰ã€‚ã€',options:[{id:'A',text:'æä¾›å¯†ç¢¼',correct:false,fb:'âŒéŠ€è¡Œçµ•ä¸è¦å¯†ç¢¼ï¼'},{id:'B',text:'æ›æ–·è‡ªæ‰“å®¢æœ',correct:true,fb:'âœ…æ­£ç¢ºï¼è‡ªå·±æ’¥å®˜æ–¹é›»è©±ã€‚'}],exp:100,gold:50},
        {id:'S003',title:'ç¶²è³¼è¶…ä½åƒ¹',diff:'ä¸­ç­‰',desc:'åç‰ŒåŒ…1/10åƒ¹æ ¼ï¼Œè¦ç§ä¸‹è½‰å¸³ã€‚',options:[{id:'A',text:'åŒ¯æ¬¾',correct:false,fb:'âŒç§ä¸‹è½‰å¸³æ²’ä¿éšœï¼'},{id:'B',text:'ç”¨å¹³å°äº¤æ˜“',correct:true,fb:'âœ…ä½¿ç”¨æœ‰ä¿éšœçš„å¹³å°ã€‚'}],exp:150,gold:80},
        {id:'S004',title:'äº¤å‹å€ŸéŒ¢',diff:'å›°é›£',desc:'ç¶²å‹èªªåª½åª½ä½é™¢å€Ÿ5è¬ã€‚',options:[{id:'A',text:'å€ŸéŒ¢',correct:false,fb:'âŒæ®ºè±¬ç›¤è©é¨™ï¼'},{id:'B',text:'è¦æ±‚è¦–è¨Š',correct:true,fb:'âœ…è©é¨™è€…æœƒæ‹’çµ•è¦–è¨Šã€‚'}],exp:200,gold:120},
        {id:'S005',title:'ä¸­çç°¡è¨Š',diff:'ç°¡å–®',desc:'ã€ŒæŠ½ä¸­iPhoneï¼ä»˜399é‹è²»é ˜å–ï¼ã€',options:[{id:'A',text:'ä»˜æ¬¾',correct:false,fb:'âŒé ä»˜è²»è©é¨™ï¼'},{id:'B',text:'ç¢ºèªæœ‰ç„¡åƒåŠ ',correct:true,fb:'âœ…æ²’åƒåŠ ä¸å¯èƒ½ä¸­çã€‚'}],exp:80,gold:40},
    ];
    const startQuest=(q)=>{setCurrentQuest(q);setQuestResult(null);setTab('playing');};
    const answerQuest=(opt)=>{
        setQuestResult(opt);
        if(opt.correct)setPlayer(p=>({...p,exp:p.exp+currentQuest.exp,gold:p.gold+currentQuest.gold,level:Math.floor((p.exp+currentQuest.exp)/300)+1,completed:[...p.completed,currentQuest.id]}));
        else setPlayer(p=>({...p,hp:Math.max(0,p.hp-20),exp:p.exp+20}));
    };

    const elemColors={ç«:'text-red-400',æ°´:'text-blue-400',è‰:'text-green-400',é›·:'text-yellow-400',å…‰:'text-amber-300',æš—:'text-purple-400',åœ°:'text-orange-400',é¢¨:'text-cyan-400',å†°:'text-sky-300'};
    const rarityColors={5:'text-yellow-400',4:'text-purple-400',3:'text-blue-400',2:'text-green-400',1:'text-slate-400'};

    if(loading)return<Loading/>;

    const tabs=[
        {id:'play',icon:'ğŸ®',name:'é˜²è©æŒ‘æˆ°'},
        {id:'creatures',icon:'ğŸ¾',name:`æ€ªç‰©(${data.creatures.length})`},
        {id:'skills',icon:'âš”ï¸',name:`æŠ€èƒ½(${data.skills.length})`},
        {id:'areas',icon:'ğŸ—ºï¸',name:`å€åŸŸ(${data.areas.length})`},
        {id:'bosses',icon:'ğŸ‘¹',name:`BOSS(${data.bosses.length})`},
        {id:'npcs',icon:'ğŸ‘¥',name:`NPC(${data.npcs.length})`},
        {id:'quests',icon:'ğŸ“œ',name:`ä»»å‹™(${data.quests.length})`},
        {id:'items',icon:'ğŸ’',name:`é“å…·(${data.items.length})`},
        {id:'shop',icon:'ğŸª',name:`å•†åº—(${data.shopItems.length})`},
        {id:'scam',icon:'ğŸš¨',name:`è©é¨™æ¡ˆä¾‹(${data.scamCases.length})`},
    ];

    // éŠæˆ²ä¸­
    if(tab==='playing'&&currentQuest){
        return(
            <div className="max-w-3xl mx-auto space-y-4">
                <button onClick={()=>setTab('play')} className="text-slate-400 hover:text-white">â† è¿”å›</button>
                <div className="card rounded-xl p-4 border border-slate-700 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center">ğŸ§™</div>
                        <div><div className="font-bold">Lv.{player.level}</div><div className="text-xs text-slate-400">{player.completed.length}/5 å®Œæˆ</div></div>
                    </div>
                    <div className="flex gap-4 text-sm"><span className="text-red-400">â¤ï¸{player.hp}</span><span className="text-yellow-400">ğŸ’°{player.gold}</span><span className="text-green-400">â­{player.exp}</span></div>
                </div>
                <div className="card rounded-xl border border-slate-700 overflow-hidden">
                    <div className="bg-gradient-to-r from-red-600 to-orange-600 p-4"><h2 className="font-bold text-lg">ğŸš¨ {currentQuest.title}</h2></div>
                    <div className="p-6">
                        <div className="bg-slate-900/50 rounded-lg p-4 mb-6 border-l-4 border-yellow-500"><p className="text-lg">{currentQuest.desc}</p></div>
                        <div className="space-y-2">
                            {currentQuest.options?.map((opt,i)=>{
                                const sel=questResult?.id===opt.id;
                                let cls='border-slate-600 hover:border-blue-500';
                                if(questResult){if(opt.correct)cls='border-green-500 bg-green-900/30';else if(sel)cls='border-red-500 bg-red-900/30 shake';else cls='border-slate-700 opacity-50';}
                                return<button key={i} onClick={()=>!questResult&&answerQuest(opt)} disabled={!!questResult} className={`w-full text-left p-3 rounded-lg border-2 transition ${cls}`}><span className="font-bold text-blue-400 mr-2">{opt.id}.</span>{opt.text}</button>;
                            })}
                        </div>
                        {questResult&&<div className={`mt-4 p-4 rounded-lg fade ${questResult.correct?'bg-green-900/30 border border-green-600':'bg-red-900/30 border border-red-600'}`}><p>{questResult.fb}</p>{questResult.correct&&<div className="mt-2 text-sm">ğŸ†+{currentQuest.exp} EXP | ğŸ’°+{currentQuest.gold}</div>}</div>}
                        {questResult&&<button onClick={()=>setTab('play')} className="w-full py-2 bg-blue-600 rounded-lg mt-4">è¿”å›</button>}
                    </div>
                </div>
            </div>
        );
    }

    // æ€ªç‰©åˆ—è¡¨
    const Creatures=()=>(
        <div className="space-y-4">
            <p className="text-sm text-slate-400">èªæ°£ç¸åœ–é‘‘ (å…±{data.creatures.length}éš»)</p>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {data.creatures.slice(0,24).map((c,i)=>(
                    <div key={i} onClick={()=>setModal({type:'creature',data:c})} className="card rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-blue-500 text-center">
                        <div className="text-4xl mb-2">ğŸ¾</div>
                        <div className={`font-bold ${rarityColors[c.rarity]}`}>{'â˜…'.repeat(c.rarity)}</div>
                        <div className="font-bold">{c.name}</div>
                        <div className={`text-sm ${elemColors[c.element]||'text-slate-400'}`}>{c.element}å±¬æ€§</div>
                        <div className="text-xs text-slate-500 mt-1">HP:{c.base_hp} ATK:{c.base_atk}</div>
                    </div>
                ))}
            </div>
        </div>
    );

    // æŠ€èƒ½åˆ—è¡¨
    const Skills=()=>(
        <div className="space-y-4">
            <div className="grid md:grid-cols-2 gap-3">
                {data.skills.slice(0,20).map((s,i)=>(
                    <div key={i} className="card rounded-lg p-3 border border-slate-700">
                        <div className="flex justify-between items-start">
                            <div className="font-bold text-blue-400">{s.skill_name}</div>
                            <span className={`text-xs px-2 py-0.5 rounded ${s.skill_type==='attack'?'bg-red-900/50 text-red-400':'bg-blue-900/50 text-blue-400'}`}>{s.skill_type}</span>
                        </div>
                        <p className="text-sm text-slate-400 mt-1">{s.description}</p>
                        <div className="mt-2 flex gap-3 text-xs text-slate-500">
                            <span>å¨åŠ›:{s.base_power}</span><span>å‘½ä¸­:{s.accuracy}</span><span>MP:{s.mp_cost}</span>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // å€åŸŸ
    const Areas=()=>(
        <div className="grid md:grid-cols-2 gap-4">
            {data.areas.map((a,i)=>(
                <div key={i} className="card rounded-xl p-4 border border-slate-700">
                    <h3 className="font-bold text-blue-400 text-lg">{a.name}</h3>
                    <p className="text-sm text-slate-400 mt-1">{a.description}</p>
                    <div className="mt-2 flex gap-3 text-xs"><span className="text-yellow-400">Lv.{a.min_level}+</span><span className="text-slate-500">{a.terrain}</span></div>
                </div>
            ))}
        </div>
    );

    // BOSS
    const Bosses=()=>(
        <div className="space-y-4">
            {data.bosses.map((b,i)=>(
                <div key={i} className="card rounded-xl p-4 border border-red-500/50">
                    <div className="flex justify-between items-start">
                        <div><h3 className="font-bold text-red-400 text-xl">ğŸ‘¹ {b.name}</h3><p className="text-sm text-slate-400 mt-1">{b.description}</p></div>
                        <span className="text-xs px-2 py-1 bg-red-900/50 text-red-400 rounded">Lv.{b.level}</span>
                    </div>
                    <div className="mt-3 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div className="text-red-400 font-bold">{b.hp}</div><div className="text-xs text-slate-500">HP</div></div>
                        <div><div className="text-orange-400 font-bold">{b.atk}</div><div className="text-xs text-slate-500">ATK</div></div>
                        <div><div className="text-blue-400 font-bold">{b.def}</div><div className="text-xs text-slate-500">DEF</div></div>
                        <div><div className="text-yellow-400 font-bold">{b.boss_type}</div><div className="text-xs text-slate-500">å±¬æ€§</div></div>
                    </div>
                    {b.skills&&<div className="mt-2 text-xs text-slate-400">æŠ€èƒ½: {JSON.parse(b.skills||'[]').join(', ')}</div>}
                </div>
            ))}
        </div>
    );

    // NPC
    const NPCs=()=>(
        <div className="grid md:grid-cols-2 gap-4">
            {data.npcs.slice(0,12).map((n,i)=>(
                <div key={i} className="card rounded-lg p-4 border border-slate-700 flex items-start gap-3">
                    <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-xl">ğŸ‘¤</div>
                    <div><div className="font-bold text-blue-400">{n.name}</div><div className="text-xs text-slate-500">{n.role} Â· {n.location}</div><div className="text-sm text-slate-400 mt-1">{n.dialogue_default}</div></div>
                </div>
            ))}
        </div>
    );

    // ä»»å‹™
    const Quests=()=>(
        <div className="space-y-3">
            {data.quests.slice(0,15).map((q,i)=>(
                <div key={i} className="card rounded-lg p-4 border border-slate-700">
                    <div className="flex justify-between items-start">
                        <div><span className={`text-xs px-2 py-0.5 rounded mr-2 ${q.quest_type==='main'?'bg-yellow-900/50 text-yellow-400':'bg-slate-700 text-slate-400'}`}>{q.quest_type}</span><span className="font-bold text-blue-400">{q.title}</span></div>
                        <span className="text-xs text-slate-500">Ch.{q.chapter}</span>
                    </div>
                    <p className="text-sm text-slate-400 mt-2">{q.description}</p>
                    {q.dialogue&&<div className="mt-2 text-xs text-green-400 bg-green-900/20 p-2 rounded">ğŸ’¬ {q.dialogue}</div>}
                </div>
            ))}
        </div>
    );

    // é“å…·
    const Items=()=>(
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            {data.items.slice(0,24).map((it,i)=>(
                <div key={i} className="card rounded-lg p-3 border border-slate-700 text-center">
                    <div className="text-3xl mb-1">{it.item_name?.includes('è—¥æ°´')?'ğŸ§ª':it.item_name?.includes('çƒ')?'âšª':'ğŸ“¦'}</div>
                    <div className="font-bold text-sm">{it.item_name}</div>
                    <div className="text-xs text-slate-400 line-clamp-2">{it.description}</div>
                </div>
            ))}
        </div>
    );

    // å•†åº—
    const Shop=()=>(
        <div className="grid md:grid-cols-2 gap-4">
            {data.shopItems.slice(0,12).map((it,i)=>(
                <div key={i} className="card rounded-lg p-4 border border-slate-700 flex items-start gap-3">
                    <div className="text-3xl">{it.item_name?.includes('è—¥æ°´')?'ğŸ§ª':it.item_name?.includes('åŠ')?'âš”ï¸':it.item_name?.includes('ç›¾')?'ğŸ›¡ï¸':'ğŸ“¦'}</div>
                    <div className="flex-1">
                        <div className="font-bold text-yellow-400">{it.item_name}</div>
                        <div className="text-sm text-slate-400">{it.description}</div>
                        <div className="mt-2 flex justify-between items-center">
                            <span className="text-yellow-500 font-bold">ğŸ’°{it.price_gold}</span>
                            <span className="text-xs text-slate-500">Lv.{it.level_required}+</span>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    );

    // è©é¨™æ¡ˆä¾‹
    const ScamCases=()=>(
        <div className="space-y-4">
            <p className="text-sm text-slate-400">çœŸå¯¦è©é¨™æ¡ˆä¾‹æ•™å­¸ ({data.scamCases.length})</p>
            <div className="grid md:grid-cols-2 gap-4">
                {data.scamCases.slice(0,10).map((c,i)=>(
                    <div key={i} className="card rounded-lg p-4 border border-red-500/30">
                        <div className="flex justify-between items-start mb-2">
                            <span className="text-xs px-2 py-0.5 bg-red-900/50 text-red-400 rounded">{c.category}</span>
                            <span className="text-xs text-slate-500">{c.id}</span>
                        </div>
                        <h4 className="font-bold text-red-400">{c.title}</h4>
                        <p className="text-sm text-slate-400 mt-2 line-clamp-2">{c.description}</p>
                        <div className="mt-2 text-xs text-green-400">âœ… {c.prevention}</div>
                    </div>
                ))}
            </div>
        </div>
    );

    // é˜²è©æŒ‘æˆ°
    const Play=()=>(
        <div className="space-y-4">
            <div className="card rounded-xl p-4 border border-slate-700">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-xl">ğŸ§™</div>
                        <div><div className="font-bold">Lv.{player.level} é˜²è©å‹‡å£«</div><div className="text-sm text-slate-400">{player.completed.length}/5 é—œå¡å®Œæˆ</div></div>
                    </div>
                    <div className="flex gap-4 text-sm">
                        <Stat icon="â¤ï¸" value={player.hp} color="text-red-400"/>
                        <Stat icon="ğŸ’°" value={player.gold} color="text-yellow-400"/>
                        <Stat icon="â­" value={player.exp} color="text-green-400"/>
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-3">
                    <div><div className="text-xs text-slate-500 mb-1">HP</div><div className="h-2 bg-slate-700 rounded-full"><div className="h-2 bg-red-500 rounded-full bar" style={{width:`${player.hp/player.maxHp*100}%`}}></div></div></div>
                    <div><div className="text-xs text-slate-500 mb-1">EXP</div><div className="h-2 bg-slate-700 rounded-full"><div className="h-2 bg-green-500 rounded-full bar" style={{width:`${(player.exp%300)/3}%`}}></div></div></div>
                </div>
            </div>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {scenarios.map((s,i)=>{
                    const done=player.completed.includes(s.id);
                    return(
                        <div key={i} className={`card rounded-xl p-4 border ${done?'border-green-600':'border-slate-700'}`}>
                            <div className="flex justify-between mb-2"><h3 className="font-bold text-blue-400">{s.title}</h3>{done&&<span className="text-green-400">âœ…</span>}</div>
                            <span className={`text-xs px-2 py-0.5 rounded ${s.diff==='ç°¡å–®'?'bg-green-900/50 text-green-400':s.diff==='ä¸­ç­‰'?'bg-yellow-900/50 text-yellow-400':'bg-red-900/50 text-red-400'}`}>{s.diff}</span>
                            <p className="text-sm text-slate-400 mt-2 line-clamp-2">{s.desc}</p>
                            <div className="mt-3 flex justify-between items-center">
                                <span className="text-xs text-slate-500">ğŸ†{s.exp} ğŸ’°{s.gold}</span>
                                <button onClick={()=>startQuest(s)} className={`px-3 py-1 rounded text-sm ${done?'bg-slate-700':'bg-blue-600'}`}>{done?'é‡ç©':'æŒ‘æˆ°'}</button>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );

    return(
        <div className="space-y-4">
            <h1 className="text-2xl font-bold">ğŸ® E18K éŠæˆ²ç³»çµ±</h1>
            <Tab tabs={tabs} active={tab} set={setTab}/>
            {tab==='play'&&<Play/>}
            {tab==='creatures'&&<Creatures/>}
            {tab==='skills'&&<Skills/>}
            {tab==='areas'&&<Areas/>}
            {tab==='bosses'&&<Bosses/>}
            {tab==='npcs'&&<NPCs/>}
            {tab==='quests'&&<Quests/>}
            {tab==='items'&&<Items/>}
            {tab==='shop'&&<Shop/>}
            {tab==='scam'&&<ScamCases/>}
            
            <Modal open={modal?.type==='creature'} onClose={()=>setModal(null)} title={modal?.data?.name}>
                {modal?.data&&(
                    <div className="space-y-4">
                        <div className="text-center"><div className="text-6xl mb-2">ğŸ¾</div><div className={`font-bold text-xl ${rarityColors[modal.data.rarity]}`}>{'â˜…'.repeat(modal.data.rarity)} {modal.data.name}</div><div className={elemColors[modal.data.element]}>{modal.data.element}å±¬æ€§</div></div>
                        <div className="card rounded-lg p-4 border border-slate-700"><p className="text-slate-300 italic">"{modal.data.quote}"</p><p className="text-slate-400 text-sm mt-2">{modal.data.lore}</p></div>
                        <div className="grid grid-cols-4 gap-2 text-center">
                            <div className="card rounded-lg p-2 border border-slate-700"><div className="text-red-400 font-bold">{modal.data.base_hp}</div><div className="text-xs text-slate-500">HP</div></div>
                            <div className="card rounded-lg p-2 border border-slate-700"><div className="text-orange-400 font-bold">{modal.data.base_atk}</div><div className="text-xs text-slate-500">ATK</div></div>
                            <div className="card rounded-lg p-2 border border-slate-700"><div className="text-blue-400 font-bold">{modal.data.base_def}</div><div className="text-xs text-slate-500">DEF</div></div>
                            <div className="card rounded-lg p-2 border border-slate-700"><div className="text-green-400 font-bold">{modal.data.base_spd}</div><div className="text-xs text-slate-500">SPD</div></div>
                        </div>
                        {modal.data.signature_skill&&<div className="card rounded-lg p-4 border border-yellow-500/30"><h4 className="font-semibold text-yellow-400 mb-1">âš¡ {modal.data.signature_skill}</h4><p className="text-slate-300 text-sm">{modal.data.signature_desc}</p></div>}
                    </div>
                )}
            </Modal>
        </div>
    );
};

// App
const App=()=>{
    const [page,setPage]=useState('home');
    return(
        <div className="min-h-screen">
            <Nav page={page} setPage={setPage}/>
            <main className="max-w-6xl mx-auto px-4 py-6">
                {page==='home'&&<Home setPage={setPage}/>}
                {page==='edu'&&<Education/>}
                {page==='game'&&<Game/>}
            </main>
            <footer className="text-center py-4 text-slate-500 text-sm border-t border-slate-800">VE-System v1.0 | åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ | é“çš„1%åŸå‰‡</footer>
        </div>
    );
};
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>