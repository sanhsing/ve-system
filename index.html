<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VE-System è™›æ“¾åœ°çƒç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .bounce { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .fade-in { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar { transition: width 0.3s; }
        .card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;
const API = 'https://ve-system.onrender.com';

// === é€šç”¨ ===
const Loading = () => <div className="flex justify-center p-8"><div className="loading-spin text-4xl">âš™ï¸</div></div>;
const Modal = ({ open, onClose, title, children, wide }) => {
    if (!open) return null;
    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className={`card rounded-2xl ${wide ? 'max-w-4xl' : 'max-w-2xl'} w-full max-h-[85vh] overflow-hidden border border-slate-600 fade-in`} onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                    <h2 className="text-xl font-bold">{title}</h2>
                    <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div className="p-4 overflow-y-auto max-h-[70vh]">{children}</div>
            </div>
        </div>
    );
};

const Navbar = ({ page, setPage }) => {
    const items = [
        { id: 'home', icon: 'ğŸ ', name: 'é¦–é ' },
        { id: 'edu', icon: 'ğŸ“š', name: 'æ•™è‚²ç³»çµ±' },
        { id: 've', icon: 'ğŸŒ', name: 'è™›æ“¬åœ°çƒ' },
        { id: 'db', icon: 'ğŸ—„ï¸', name: 'è³‡æ–™åº«' },
    ];
    return (
        <nav className="bg-slate-900/80 backdrop-blur border-b border-slate-700 sticky top-0 z-50">
            <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setPage('home')}>
                    <span className="text-2xl">ğŸŒŒ</span>
                    <span className="font-bold text-lg bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">VE-System</span>
                </div>
                <div className="flex gap-1">
                    {items.map(i => (
                        <button key={i.id} onClick={() => setPage(i.id)}
                            className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition ${page === i.id ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>
                            <span>{i.icon}</span><span className="hidden sm:inline">{i.name}</span>
                        </button>
                    ))}
                </div>
            </div>
        </nav>
    );
};

// === é¦–é  ===
const Home = ({ setPage }) => {
    const [status, setStatus] = useState(null);
    useEffect(() => { fetch(`${API}/api/v1/status`).then(r => r.json()).then(setStatus).catch(() => {}); }, []);
    
    return (
        <div className="space-y-6">
            <div className="text-center py-8">
                <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">è™›æ“¾åœ°çƒç³»çµ±</h1>
                <p className="text-slate-400 mt-2">Virtual Earth System v1.0</p>
                <div className="mt-4 inline-flex items-center px-4 py-2 bg-green-900/50 rounded-full border border-green-500">
                    <span className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                    <span className="text-green-400">ç³»çµ±é‹è¡Œä¸­</span>
                </div>
            </div>
            
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="card rounded-xl p-4 border border-slate-700">
                    <div className="text-3xl font-bold text-blue-400">{status?.maturity || '90.7%'}</div>
                    <div className="text-slate-500 text-sm">ç³»çµ±æˆç†Ÿåº¦</div>
                </div>
                <div className="card rounded-xl p-4 border border-slate-700">
                    <div className="text-3xl font-bold text-purple-400">{status?.totals?.databases || 9}</div>
                    <div className="text-slate-500 text-sm">è³‡æ–™åº«</div>
                </div>
                <div className="card rounded-xl p-4 border border-slate-700">
                    <div className="text-3xl font-bold text-green-400">{status?.totals?.tables?.toLocaleString() || '1,663'}</div>
                    <div className="text-slate-500 text-sm">è³‡æ–™è¡¨</div>
                </div>
                <div className="card rounded-xl p-4 border border-slate-700">
                    <div className="text-3xl font-bold text-yellow-400">{status?.totals?.records?.toLocaleString() || '146,626'}</div>
                    <div className="text-slate-500 text-sm">è³‡æ–™ç­†æ•¸</div>
                </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
                <div onClick={() => setPage('edu')} className="card rounded-xl p-6 border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                    <div className="flex items-center gap-4">
                        <div className="text-5xl">ğŸ“š</div>
                        <div>
                            <h2 className="text-xl font-bold">æ•™è‚²ç³»çµ±</h2>
                            <p className="text-slate-400 text-sm mt-1">çŸ¥è­˜æŒ‘æˆ° Â· AIèªè­‰èª²ç¨‹ Â· æˆå°±ç³»çµ±</p>
                            <div className="mt-2 flex gap-2">
                                <span className="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded">107+ é¡Œåº«</span>
                                <span className="text-xs px-2 py-1 bg-purple-900/50 text-purple-400 rounded">12 æˆå°±</span>
                                <span className="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded">AIèª²ç¨‹</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div onClick={() => setPage('ve')} className="card rounded-xl p-6 border border-slate-700 cursor-pointer hover:border-green-500 transition">
                    <div className="flex items-center gap-4">
                        <div className="text-5xl">ğŸŒ</div>
                        <div>
                            <h2 className="text-xl font-bold">è™›æ“¬åœ°çƒ E18K</h2>
                            <p className="text-slate-400 text-sm mt-1">é˜²è©éŠæˆ² Â· NPCå°è©± Â· ä»»å‹™ç³»çµ±</p>
                            <div className="mt-2 flex gap-2">
                                <span className="text-xs px-2 py-1 bg-red-900/50 text-red-400 rounded">11 ä»»å‹™</span>
                                <span className="text-xs px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded">8 NPC</span>
                                <span className="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded">å•†åº—ç³»çµ±</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// === æ•™è‚²ç³»çµ± ===
const Education = () => {
    const [tab, setTab] = useState('quiz');
    const [mode, setMode] = useState('menu');
    const [questions, setQuestions] = useState([]);
    const [currentQ, setCurrentQ] = useState(0);
    const [answer, setAnswer] = useState(null);
    const [result, setResult] = useState(null);
    const [score, setScore] = useState({ correct: 0, total: 0, streak: 0, maxStreak: 0 });
    const [loading, setLoading] = useState(false);
    const [subject, setSubject] = useState('all');
    const [count, setCount] = useState(10);
    const [timer, setTimer] = useState(30);
    const [timerOn, setTimerOn] = useState(false);
    const [achievements, setAchievements] = useState([]);
    const [badges, setBadges] = useState([]);
    const [levels, setLevels] = useState([]);
    const [modules, setModules] = useState([]);
    const [lessons, setLessons] = useState([]);
    const [selectedLesson, setSelectedLesson] = useState(null);
    const [player, setPlayer] = useState({ xp: 0, level: 1, title: 'å­¸ç¿’æ–°æ‰‹', badges: [] });

    const subjects = [
        { id: 'all', name: 'å…¨éƒ¨', icon: 'ğŸ“š' },
        { id: 'æ•¸å­¸', name: 'æ•¸å­¸', icon: 'ğŸ”¢' },
        { id: 'åœ‹æ–‡', name: 'åœ‹æ–‡', icon: 'ğŸ“–' },
        { id: 'è‹±æ–‡', name: 'è‹±æ–‡', icon: 'ğŸ”¤' },
        { id: 'è‡ªç„¶', name: 'è‡ªç„¶', icon: 'ğŸ”¬' },
        { id: 'ç¤¾æœƒ', name: 'ç¤¾æœƒ', icon: 'ğŸŒ' },
    ];

    // è¼‰å…¥æˆå°±ã€å¾½ç« ã€ç­‰ç´šã€èª²ç¨‹
    useEffect(() => {
        Promise.all([
            fetch(`${API}/api/v1/db/education/table/achievements?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/education/table/badges?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/education/table/level_thresholds?limit=10`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/education/table/ai_cert_modules?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/education/table/ai_cert_lessons?limit=50`).then(r => r.json()).catch(() => ({ data: [] })),
        ]).then(([ach, bdg, lvl, mod, les]) => {
            setAchievements(ach.data || []);
            setBadges(bdg.data || []);
            setLevels(lvl.data || []);
            setModules(mod.data || []);
            setLessons(les.data || []);
        });
    }, []);

    // è¨ˆæ™‚å™¨
    useEffect(() => {
        if (timerOn && timer > 0) {
            const t = setTimeout(() => setTimer(v => v - 1), 1000);
            return () => clearTimeout(t);
        } else if (timer === 0 && timerOn) {
            setTimerOn(false);
            setResult({ correct: false, timeout: true, correct_answer: questions[currentQ]?.answer });
            setScore(p => ({ ...p, total: p.total + 1, streak: 0 }));
        }
    }, [timer, timerOn]);

    // æ›´æ–°ç©å®¶ç­‰ç´š
    useEffect(() => {
        const lvl = levels.find(l => player.xp >= l.xp_required) || levels[0];
        if (lvl && lvl.level !== player.level) {
            setPlayer(p => ({ ...p, level: lvl.level, title: lvl.title }));
        }
    }, [player.xp, levels]);

    const loadQuestions = async () => {
        setLoading(true);
        try {
            const url = subject === 'all' ? `${API}/api/v1/education/questions?limit=${count}` : `${API}/api/v1/education/questions?limit=${count}&subject=${subject}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.questions?.length > 0) {
                setQuestions(data.questions);
                setCurrentQ(0);
                setScore({ correct: 0, total: 0, streak: 0, maxStreak: 0 });
                setAnswer(null);
                setResult(null);
                setMode('quiz');
                setTimer(30);
                setTimerOn(true);
            } else {
                alert('æ­¤ç§‘ç›®æ²’æœ‰é¡Œç›®');
            }
        } catch (e) { alert('è¼‰å…¥å¤±æ•—'); }
        setLoading(false);
    };

    const checkAnswer = async (ans) => {
        if (result) return;
        setAnswer(ans);
        setTimerOn(false);
        try {
            const res = await fetch(`${API}/api/v1/education/check`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question_id: questions[currentQ].question_id, answer: ans })
            });
            const data = await res.json();
            setResult(data);
            const newStreak = data.correct ? score.streak + 1 : 0;
            const xpGain = data.correct ? 20 : 5;
            setScore(p => ({ correct: p.correct + (data.correct ? 1 : 0), total: p.total + 1, streak: newStreak, maxStreak: Math.max(p.maxStreak, newStreak) }));
            setPlayer(p => ({ ...p, xp: p.xp + xpGain }));
        } catch (e) {}
    };

    const nextQuestion = () => {
        if (currentQ < questions.length - 1) {
            setCurrentQ(p => p + 1);
            setAnswer(null);
            setResult(null);
            setTimer(30);
            setTimerOn(true);
        } else {
            setMode('result');
        }
    };

    // æ¸¬é©—é¸å–®
    const QuizMenu = () => (
        <div className="space-y-6">
            <div className="grid md:grid-cols-2 gap-6">
                <div className="card rounded-xl p-6 border border-slate-700">
                    <h3 className="font-semibold mb-4">ğŸ¯ é¸æ“‡ç§‘ç›®</h3>
                    <div className="grid grid-cols-3 gap-2">
                        {subjects.map(s => (
                            <button key={s.id} onClick={() => setSubject(s.id)}
                                className={`p-3 rounded-lg border text-center transition ${subject === s.id ? 'bg-blue-600 border-blue-500' : 'border-slate-600 hover:border-blue-500'}`}>
                                <div className="text-2xl">{s.icon}</div>
                                <div className="text-sm mt-1">{s.name}</div>
                            </button>
                        ))}
                    </div>
                </div>
                <div className="card rounded-xl p-6 border border-slate-700">
                    <h3 className="font-semibold mb-4">ğŸ“Š è¨­å®š</h3>
                    <div className="mb-4">
                        <div className="text-sm text-slate-400 mb-2">é¡Œç›®æ•¸é‡</div>
                        <div className="flex gap-2">
                            {[5, 10, 15, 20].map(n => (
                                <button key={n} onClick={() => setCount(n)}
                                    className={`px-4 py-2 rounded-lg ${count === n ? 'bg-green-600' : 'bg-slate-700 hover:bg-slate-600'}`}>{n}</button>
                            ))}
                        </div>
                    </div>
                    <button onClick={loadQuestions} disabled={loading}
                        className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg font-bold mt-4">
                        {loading ? 'è¼‰å…¥ä¸­...' : 'ğŸš€ é–‹å§‹æŒ‘æˆ°'}
                    </button>
                </div>
            </div>
            
            {/* ç©å®¶ç‹€æ…‹ */}
            <div className="card rounded-xl p-4 border border-slate-700">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-xl">ğŸ“</div>
                        <div>
                            <div className="font-bold">Lv.{player.level} {player.title}</div>
                            <div className="text-sm text-slate-400">ç¶“é©—å€¼: {player.xp}</div>
                        </div>
                    </div>
                    <div className="text-right">
                        <div className="text-sm text-slate-400">ä¸‹ä¸€ç­‰ç´š</div>
                        <div className="text-sm">{levels.find(l => l.level === player.level + 1)?.xp_required - player.xp || '???'} XP</div>
                    </div>
                </div>
            </div>
        </div>
    );

    // æ¸¬é©—ä¸­
    const Quiz = () => {
        const q = questions[currentQ];
        if (!q) return <Loading />;
        const opts = Array.isArray(q.options) ? q.options : [];
        
        return (
            <div className="max-w-3xl mx-auto space-y-4">
                <div className="flex justify-between items-center">
                    <button onClick={() => { setMode('menu'); setTimerOn(false); }} className="text-slate-400 hover:text-white">â† è¿”å›</button>
                    <div className="flex items-center gap-4">
                        {score.streak >= 3 && <span className="text-orange-400 bounce">ğŸ”¥ {score.streak}</span>}
                        <span className="text-green-400 font-bold">{score.correct}/{score.total}</span>
                    </div>
                </div>
                
                <div className="card rounded-xl p-6 border border-slate-700">
                    <div className="flex justify-between text-sm text-slate-400 mb-2">
                        <span>é¡Œç›® {currentQ + 1}/{questions.length}</span>
                        <span className={timer <= 10 ? 'text-red-400 font-bold' : ''}>{timer}s</span>
                    </div>
                    <div className="h-1.5 bg-slate-700 rounded-full mb-1">
                        <div className="h-1.5 bg-blue-500 rounded-full progress-bar" style={{ width: `${((currentQ + 1) / questions.length) * 100}%` }}></div>
                    </div>
                    <div className="h-1 bg-slate-700 rounded-full mb-4">
                        <div className={`h-1 rounded-full progress-bar ${timer <= 10 ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${(timer / 30) * 100}%` }}></div>
                    </div>
                    
                    <div className="mb-2"><span className="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded">{q.subject || q.subject_id}</span></div>
                    <h2 className="text-lg mb-6">{q.question_text}</h2>
                    
                    <div className="space-y-2">
                        {opts.map((opt, i) => {
                            const letter = opt.charAt(0);
                            const isSelected = answer === letter;
                            const isCorrect = result?.correct_answer === letter;
                            const isWrong = isSelected && !result?.correct;
                            let cls = 'border-slate-600 hover:border-blue-500';
                            if (result) {
                                if (isCorrect) cls = 'border-green-500 bg-green-900/30 bounce';
                                else if (isWrong) cls = 'border-red-500 bg-red-900/30 shake';
                                else cls = 'border-slate-700 opacity-50';
                            }
                            return (
                                <button key={i} onClick={() => checkAnswer(letter)} disabled={!!result}
                                    className={`w-full text-left p-3 rounded-lg border-2 transition ${cls}`}>
                                    <span className="font-bold mr-2">{letter}.</span>{opt.substring(2)}
                                </button>
                            );
                        })}
                    </div>
                    
                    {result && (
                        <div className={`mt-4 p-4 rounded-lg fade-in ${result.correct ? 'bg-green-900/30 border border-green-600' : 'bg-red-900/30 border border-red-600'}`}>
                            <div className="font-bold">
                                {result.timeout ? 'â° æ™‚é–“åˆ°ï¼' : result.correct ? 'âœ… ç­”å°äº†ï¼+20 XP' : 'âŒ ç­”éŒ¯äº† +5 XP'}
                                {!result.correct && <span className="ml-2 text-green-400">æ­£ç¢º: {result.correct_answer}</span>}
                            </div>
                            {q.explanation && <p className="text-slate-300 text-sm mt-2">{q.explanation}</p>}
                        </div>
                    )}
                    
                    {result && (
                        <button onClick={nextQuestion} className="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold mt-4">
                            {currentQ < questions.length - 1 ? 'ä¸‹ä¸€é¡Œ â†’' : 'æŸ¥çœ‹çµæœ ğŸ†'}
                        </button>
                    )}
                </div>
            </div>
        );
    };

    // çµæœ
    const Result = () => {
        const pct = Math.round((score.correct / score.total) * 100);
        const grade = pct >= 90 ? 'S' : pct >= 80 ? 'A' : pct >= 70 ? 'B' : pct >= 60 ? 'C' : 'D';
        const colors = { S: 'text-yellow-400', A: 'text-green-400', B: 'text-blue-400', C: 'text-orange-400', D: 'text-red-400' };
        return (
            <div className="max-w-md mx-auto card rounded-xl p-8 border border-slate-700 text-center">
                <div className="text-5xl mb-4">ğŸ‰</div>
                <h2 className="text-2xl font-bold">æŒ‘æˆ°å®Œæˆï¼</h2>
                <div className={`text-8xl font-bold my-6 ${colors[grade]}`}>{grade}</div>
                <div className="grid grid-cols-3 gap-4 mb-6">
                    <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold text-green-400">{score.correct}</div><div className="text-xs text-slate-500">ç­”å°</div></div>
                    <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold">{pct}%</div><div className="text-xs text-slate-500">æ­£ç¢ºç‡</div></div>
                    <div className="bg-slate-800 p-3 rounded-lg"><div className="text-2xl font-bold text-orange-400">{score.maxStreak}</div><div className="text-xs text-slate-500">æœ€é«˜é€£å‹</div></div>
                </div>
                <div className="flex gap-3">
                    <button onClick={() => setMode('menu')} className="flex-1 py-2 bg-slate-700 rounded-lg">è¿”å›</button>
                    <button onClick={loadQuestions} className="flex-1 py-2 bg-blue-600 rounded-lg">å†ç©</button>
                </div>
            </div>
        );
    };

    // AI èª²ç¨‹
    const Courses = () => (
        <div className="space-y-4">
            <h3 className="font-semibold">ğŸ“– AI èªè­‰èª²ç¨‹</h3>
            <div className="grid md:grid-cols-2 gap-4">
                {modules.map((m, i) => (
                    <div key={i} className="card rounded-xl p-4 border border-slate-700">
                        <div className="flex justify-between items-start">
                            <div>
                                <h4 className="font-bold text-blue-400">{m.module_name_zh || m.module_name}</h4>
                                <p className="text-sm text-slate-400 mt-1">{m.description?.substring(0, 60)}...</p>
                            </div>
                            <span className="text-xs px-2 py-1 bg-slate-700 rounded">é›£åº¦ {m.difficulty}</span>
                        </div>
                        <div className="mt-3 flex justify-between items-center text-sm">
                            <span className="text-slate-500">â±ï¸ {m.estimated_hours}h</span>
                            <button onClick={() => {
                                const relatedLessons = lessons.filter(l => l.module_id === m.module_id);
                                if (relatedLessons.length > 0) setSelectedLesson(relatedLessons[0]);
                            }} className="px-3 py-1 bg-blue-600 rounded text-xs">å­¸ç¿’</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // æˆå°±
    const Achievements = () => (
        <div className="space-y-4">
            <h3 className="font-semibold">ğŸ† æˆå°±ç³»çµ±</h3>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                {achievements.map((a, i) => (
                    <div key={i} className="card rounded-lg p-3 border border-slate-700 flex items-center gap-3">
                        <div className="text-3xl">{a.badge_icon}</div>
                        <div>
                            <div className="font-semibold">{a.name}</div>
                            <div className="text-xs text-slate-400">{a.description}</div>
                            <div className="text-xs text-yellow-400 mt-1">+{a.points} é»</div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // å¾½ç« 
    const Badges = () => (
        <div className="space-y-4">
            <h3 className="font-semibold">ğŸ–ï¸ å¾½ç« æ”¶é›†</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {badges.map((b, i) => (
                    <div key={i} className="card rounded-lg p-4 border border-slate-700 text-center">
                        <div className="text-4xl mb-2">{b.icon}</div>
                        <div className="font-semibold text-sm">{b.name}</div>
                        <div className="text-xs text-slate-400 mt-1">{b.description}</div>
                        <div className="text-xs text-green-400 mt-1">+{b.xp_reward} XP</div>
                    </div>
                ))}
            </div>
        </div>
    );

    return (
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸ“š æ•™è‚²ç³»çµ±</h1>
            
            <div className="flex gap-2 flex-wrap">
                <button onClick={() => { setTab('quiz'); setMode('menu'); }} className={`px-4 py-2 rounded-lg ${tab === 'quiz' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ¯ çŸ¥è­˜æŒ‘æˆ°</button>
                <button onClick={() => setTab('course')} className={`px-4 py-2 rounded-lg ${tab === 'course' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ“– AIèª²ç¨‹</button>
                <button onClick={() => setTab('achieve')} className={`px-4 py-2 rounded-lg ${tab === 'achieve' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ† æˆå°±</button>
                <button onClick={() => setTab('badge')} className={`px-4 py-2 rounded-lg ${tab === 'badge' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ–ï¸ å¾½ç« </button>
            </div>
            
            {tab === 'quiz' && (mode === 'menu' ? <QuizMenu /> : mode === 'quiz' ? <Quiz /> : <Result />)}
            {tab === 'course' && <Courses />}
            {tab === 'achieve' && <Achievements />}
            {tab === 'badge' && <Badges />}
            
            <Modal open={!!selectedLesson} onClose={() => setSelectedLesson(null)} title={selectedLesson?.lesson_name_zh || selectedLesson?.lesson_name} wide>
                {selectedLesson && (
                    <div className="prose prose-invert max-w-none">
                        <div className="text-sm text-slate-400 mb-4">â±ï¸ é è¨ˆ {selectedLesson.estimated_minutes} åˆ†é˜</div>
                        <div className="whitespace-pre-wrap text-sm leading-relaxed">{selectedLesson.content}</div>
                    </div>
                )}
            </Modal>
        </div>
    );
};

// === è™›æ“¬åœ°çƒ ===
const VirtualEarth = () => {
    const [tab, setTab] = useState('game');
    const [quests, setQuests] = useState([]);
    const [npcs, setNpcs] = useState([]);
    const [shop, setShop] = useState([]);
    const [dialogues, setDialogues] = useState([]);
    const [currentQuest, setCurrentQuest] = useState(null);
    const [currentNpc, setCurrentNpc] = useState(null);
    const [questResult, setQuestResult] = useState(null);
    const [dialogueState, setDialogueState] = useState(null);
    const [player, setPlayer] = useState({ hp: 100, maxHp: 100, gold: 500, exp: 0, level: 1, completed: [], inventory: [] });
    const [modalOpen, setModalOpen] = useState(false);
    const [modalContent, setModalContent] = useState(null);

    // é˜²è©æƒ…å¢ƒ
    const scenarios = [
        { id: 'S001', title: 'ç¥ç§˜æŠ•è³‡æ©Ÿæœƒ', difficulty: 'ç°¡å–®', description: 'ä½ æ”¶åˆ°è¨Šæ¯ï¼šã€Œç¨å®¶å…§ç·šï¼ä¿è­‰å ±é…¬50%ï¼åªé™ä»Šå¤©ï¼ã€', options: [{ id: 'A', text: 'ç«‹å³åŒ¯æ¬¾', correct: false, feedback: 'âŒ ã€Œä¿è­‰ç²åˆ©ã€æ˜¯æœ€å¤§è­¦è¨Šï¼' }, { id: 'B', text: 'æŸ¥è­‰èº«ä»½', correct: true, feedback: 'âœ… æ­£ç¢ºï¼æ°¸é å…ˆæŸ¥è­‰ã€‚' }], exp: 100, gold: 50 },
        { id: 'S002', title: 'å‡å†’éŠ€è¡Œ', difficulty: 'ç°¡å–®', description: 'ã€Œæˆ‘æ˜¯éŠ€è¡Œé¢¨æ§ï¼Œå¸³æˆ¶ç•°å¸¸ï¼Œè«‹æä¾›å¯†ç¢¼é©—è­‰ã€‚ã€', options: [{ id: 'A', text: 'æä¾›å¯†ç¢¼', correct: false, feedback: 'âŒ éŠ€è¡Œçµ•ä¸è¦å¯†ç¢¼ï¼' }, { id: 'B', text: 'æ›æ–·è‡ªæ‰“å®¢æœ', correct: true, feedback: 'âœ… æ­£ç¢ºï¼è‡ªå·±æ’¥å®˜æ–¹é›»è©±ã€‚' }], exp: 100, gold: 50 },
        { id: 'S003', title: 'ç¶²è³¼è¶…ä½åƒ¹', difficulty: 'ä¸­ç­‰', description: 'åç‰ŒåŒ…1/10åƒ¹æ ¼ï¼Œè¦ç§ä¸‹è½‰å¸³ã€‚', options: [{ id: 'A', text: 'åŒ¯æ¬¾', correct: false, feedback: 'âŒ ç§ä¸‹è½‰å¸³æ²’ä¿éšœï¼' }, { id: 'B', text: 'ç”¨è¦çš®äº¤æ˜“', correct: true, feedback: 'âœ… ä½¿ç”¨æœ‰ä¿éšœçš„å¹³å°ã€‚' }], exp: 150, gold: 80 },
        { id: 'S004', title: 'äº¤å‹å€ŸéŒ¢', difficulty: 'å›°é›£', description: 'ç¶²å‹èªªåª½åª½ä½é™¢å€Ÿ5è¬ã€‚', options: [{ id: 'A', text: 'å€ŸéŒ¢', correct: false, feedback: 'âŒ æ®ºè±¬ç›¤è©é¨™ï¼' }, { id: 'B', text: 'è¦æ±‚è¦–è¨Š', correct: true, feedback: 'âœ… è©é¨™è€…æœƒæ‹’çµ•è¦–è¨Šã€‚' }], exp: 200, gold: 120 },
        { id: 'S005', title: 'ä¸­çç°¡è¨Š', difficulty: 'ç°¡å–®', description: 'ã€ŒæŠ½ä¸­iPhoneï¼ä»˜399é‹è²»é ˜å–ï¼ã€', options: [{ id: 'A', text: 'ä»˜æ¬¾', correct: false, feedback: 'âŒ é ä»˜è²»è©é¨™ï¼' }, { id: 'B', text: 'ç¢ºèªæœ‰ç„¡åƒåŠ ', correct: true, feedback: 'âœ… æ²’åƒåŠ ä¸å¯èƒ½ä¸­çã€‚' }], exp: 80, gold: 40 },
    ];

    useEffect(() => {
        Promise.all([
            fetch(`${API}/api/v1/db/ve/table/quest_rewards?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/ve/table/npc_dialogues?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
            fetch(`${API}/api/v1/db/ve/table/shop_items?limit=20`).then(r => r.json()).catch(() => ({ data: [] })),
        ]).then(([q, n, s]) => {
            setQuests(q.data || []);
            setNpcs(n.data || []);
            setShop(s.data || []);
        });
    }, []);

    const startQuest = (q) => { setCurrentQuest(q); setQuestResult(null); setTab('playing'); };
    const answerQuest = (opt) => {
        setQuestResult(opt);
        if (opt.correct) {
            setPlayer(p => ({ ...p, exp: p.exp + currentQuest.exp, gold: p.gold + currentQuest.gold, level: Math.floor((p.exp + currentQuest.exp) / 300) + 1, completed: [...p.completed, currentQuest.id] }));
        } else {
            setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - 20), exp: p.exp + 20 }));
        }
    };
    const nextQuest = () => {
        const idx = scenarios.findIndex(s => s.id === currentQuest.id);
        if (idx < scenarios.length - 1) startQuest(scenarios[idx + 1]);
        else { setTab('game'); setCurrentQuest(null); }
    };
    const buyItem = (item) => {
        const price = item.price_gold || item.price || 0;
        if (player.gold >= price) {
            setPlayer(p => ({ ...p, gold: p.gold - price, inventory: [...p.inventory, item.item_name], hp: item.item_name?.includes('è—¥æ°´') ? Math.min(p.maxHp, p.hp + 50) : p.hp }));
            setModalContent({ type: 'success', msg: `è³¼è²· ${item.item_name} æˆåŠŸï¼` });
            setModalOpen(true);
        } else {
            setModalContent({ type: 'error', msg: 'é‡‘å¹£ä¸è¶³ï¼' });
            setModalOpen(true);
        }
    };
    const talkNpc = (npc) => { setCurrentNpc(npc); setDialogueState({ text: npc.dialogue_text, options: JSON.parse(npc.options || '[]') }); };

    const PlayerBar = () => (
        <div className="card rounded-xl p-4 border border-slate-700 mb-6">
            <div className="flex flex-wrap items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-xl">ğŸ§™</div>
                    <div>
                        <div className="font-bold">Lv.{player.level} é˜²è©å‹‡å£«</div>
                        <div className="text-sm text-slate-400">å·²å®Œæˆ {player.completed.length}/{scenarios.length} é—œ</div>
                    </div>
                </div>
                <div className="flex gap-4 text-sm">
                    <div><span className="text-red-400">â¤ï¸ {player.hp}/{player.maxHp}</span></div>
                    <div><span className="text-yellow-400">ğŸ’° {player.gold}</span></div>
                    <div><span className="text-green-400">â­ {player.exp}</span></div>
                    <div><span className="text-blue-400">ğŸ’ {player.inventory.length}</span></div>
                </div>
            </div>
            <div className="grid grid-cols-2 gap-2 mt-3">
                <div><div className="text-xs text-slate-500 mb-1">HP</div><div className="h-2 bg-slate-700 rounded-full"><div className="h-2 bg-red-500 rounded-full progress-bar" style={{ width: `${(player.hp / player.maxHp) * 100}%` }}></div></div></div>
                <div><div className="text-xs text-slate-500 mb-1">EXP</div><div className="h-2 bg-slate-700 rounded-full"><div className="h-2 bg-green-500 rounded-full progress-bar" style={{ width: `${(player.exp % 300) / 3}%` }}></div></div></div>
            </div>
        </div>
    );

    // éŠæˆ²ä¸­
    if (tab === 'playing' && currentQuest) {
        return (
            <div className="max-w-3xl mx-auto">
                <PlayerBar />
                <div className="card rounded-xl border border-slate-700 overflow-hidden">
                    <div className="bg-gradient-to-r from-red-600 to-orange-600 p-4">
                        <div className="flex justify-between">
                            <h2 className="font-bold text-lg">ğŸš¨ {currentQuest.title}</h2>
                            <span className={`px-2 py-1 rounded text-xs ${currentQuest.difficulty === 'ç°¡å–®' ? 'bg-green-900 text-green-300' : currentQuest.difficulty === 'ä¸­ç­‰' ? 'bg-yellow-900 text-yellow-300' : 'bg-red-900 text-red-300'}`}>{currentQuest.difficulty}</span>
                        </div>
                    </div>
                    <div className="p-6">
                        <div className="bg-slate-900/50 rounded-lg p-4 mb-6 border-l-4 border-yellow-500">
                            <p className="text-lg">{currentQuest.description}</p>
                        </div>
                        <div className="space-y-2">
                            {currentQuest.options?.map((opt, i) => {
                                const isSelected = questResult?.id === opt.id;
                                let cls = 'border-slate-600 hover:border-blue-500';
                                if (questResult) {
                                    if (opt.correct) cls = 'border-green-500 bg-green-900/30';
                                    else if (isSelected) cls = 'border-red-500 bg-red-900/30 shake';
                                    else cls = 'border-slate-700 opacity-50';
                                }
                                return (
                                    <button key={i} onClick={() => !questResult && answerQuest(opt)} disabled={!!questResult}
                                        className={`w-full text-left p-3 rounded-lg border-2 transition ${cls}`}>
                                        <span className="font-bold text-blue-400 mr-2">{opt.id}.</span>{opt.text}
                                    </button>
                                );
                            })}
                        </div>
                        {questResult && (
                            <div className={`mt-4 p-4 rounded-lg fade-in ${questResult.correct ? 'bg-green-900/30 border border-green-600' : 'bg-red-900/30 border border-red-600'}`}>
                                <p>{questResult.feedback}</p>
                                {questResult.correct && <div className="mt-2 text-sm">ğŸ† +{currentQuest.exp} EXP | ğŸ’° +{currentQuest.gold}</div>}
                                {!questResult.correct && <div className="mt-2 text-sm text-red-400">â¤ï¸ -20 HP | â­ +20 EXP</div>}
                            </div>
                        )}
                        {questResult && (
                            <div className="flex gap-3 mt-4">
                                <button onClick={() => { setTab('game'); setCurrentQuest(null); }} className="flex-1 py-2 bg-slate-700 rounded-lg">è¿”å›</button>
                                <button onClick={nextQuest} className="flex-1 py-2 bg-blue-600 rounded-lg">{scenarios.findIndex(s => s.id === currentQuest.id) < scenarios.length - 1 ? 'ä¸‹ä¸€é—œ â†’' : 'å®Œæˆ'}</button>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸŒ è™›æ“¬åœ°çƒ - E18K é˜²è©éŠæˆ²</h1>
            <PlayerBar />
            
            <div className="flex gap-2 flex-wrap">
                <button onClick={() => setTab('game')} className={`px-4 py-2 rounded-lg ${tab === 'game' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ® æƒ…å¢ƒæŒ‘æˆ°</button>
                <button onClick={() => setTab('quest')} className={`px-4 py-2 rounded-lg ${tab === 'quest' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ“œ ä»»å‹™ ({quests.length})</button>
                <button onClick={() => setTab('npc')} className={`px-4 py-2 rounded-lg ${tab === 'npc' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸ‘¥ NPC ({npcs.length})</button>
                <button onClick={() => setTab('shop')} className={`px-4 py-2 rounded-lg ${tab === 'shop' ? 'bg-blue-600' : 'bg-slate-700'}`}>ğŸª å•†åº— ({shop.length})</button>
            </div>
            
            {tab === 'game' && (
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {scenarios.map((s, i) => {
                        const done = player.completed.includes(s.id);
                        return (
                            <div key={i} className={`card rounded-xl p-4 border ${done ? 'border-green-600' : 'border-slate-700'}`}>
                                <div className="flex justify-between mb-2">
                                    <h3 className="font-bold text-blue-400">{s.title}</h3>
                                    {done && <span className="text-green-400">âœ…</span>}
                                </div>
                                <span className={`text-xs px-2 py-1 rounded ${s.difficulty === 'ç°¡å–®' ? 'bg-green-900/50 text-green-400' : s.difficulty === 'ä¸­ç­‰' ? 'bg-yellow-900/50 text-yellow-400' : 'bg-red-900/50 text-red-400'}`}>{s.difficulty}</span>
                                <p className="text-sm text-slate-400 mt-2 line-clamp-2">{s.description}</p>
                                <div className="mt-3 flex justify-between items-center">
                                    <span className="text-xs text-slate-500">ğŸ†{s.exp} ğŸ’°{s.gold}</span>
                                    <button onClick={() => startQuest(s)} className={`px-3 py-1 rounded text-sm ${done ? 'bg-slate-700' : 'bg-blue-600'}`}>{done ? 'é‡ç©' : 'æŒ‘æˆ°'}</button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}
            
            {tab === 'quest' && (
                <div className="space-y-3">
                    {quests.map((q, i) => (
                        <div key={i} className="card rounded-xl p-4 border border-slate-700">
                            <div className="flex justify-between">
                                <div>
                                    <h3 className="font-bold text-blue-400">{q.quest_name}</h3>
                                    <div className="text-xs text-slate-500 mt-1">é›£åº¦: {q.difficulty}</div>
                                </div>
                                <div className="text-right text-sm">
                                    <div className="text-yellow-400">ğŸ† {q.exp_reward} EXP</div>
                                    <div className="text-yellow-500">ğŸ’° {q.gold_reward}</div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            
            {tab === 'npc' && (
                <div className="grid md:grid-cols-2 gap-4">
                    {npcs.slice(0, 8).map((n, i) => (
                        <div key={i} onClick={() => talkNpc(n)} className="card rounded-xl p-4 border border-slate-700 cursor-pointer hover:border-blue-500">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-xl">ğŸ‘¤</div>
                                <div>
                                    <h3 className="font-bold text-blue-400">{n.npc_name}</h3>
                                    <p className="text-sm text-slate-400 line-clamp-1">{n.dialogue_text?.substring(0, 40)}...</p>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            
            {tab === 'shop' && (
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {shop.map((item, i) => (
                        <div key={i} className="card rounded-xl p-4 border border-slate-700">
                            <div className="flex items-start gap-3">
                                <div className="text-3xl">{item.item_name?.includes('è—¥æ°´') ? 'ğŸ§ª' : item.item_name?.includes('åŠ') ? 'âš”ï¸' : item.item_name?.includes('ç›¾') ? 'ğŸ›¡ï¸' : 'ğŸ“¦'}</div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-yellow-400">{item.item_name}</h3>
                                    <p className="text-sm text-slate-400">{item.description}</p>
                                </div>
                            </div>
                            <div className="mt-3 flex justify-between items-center">
                                <span className="text-yellow-500 font-bold">ğŸ’° {item.price_gold}</span>
                                <button onClick={() => buyItem(item)} className={`px-3 py-1 rounded text-sm ${player.gold >= item.price_gold ? 'bg-yellow-600' : 'bg-slate-700'}`}>è³¼è²·</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            
            <Modal open={!!currentNpc} onClose={() => setCurrentNpc(null)} title={`ğŸ’¬ ${currentNpc?.npc_name}`}>
                {dialogueState && (
                    <div>
                        <div className="bg-slate-900 p-4 rounded-lg mb-4">{dialogueState.text}</div>
                        <div className="space-y-2">
                            {dialogueState.options?.map((opt, i) => (
                                <button key={i} className="w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg">{opt}</button>
                            ))}
                        </div>
                    </div>
                )}
            </Modal>
            <Modal open={modalOpen} onClose={() => setModalOpen(false)} title="æç¤º">
                <div className="text-center py-4">
                    <div className="text-4xl mb-4">{modalContent?.type === 'success' ? 'âœ…' : 'âŒ'}</div>
                    <p>{modalContent?.msg}</p>
                </div>
            </Modal>
        </div>
    );
};

// === è³‡æ–™åº« ===
const Database = () => {
    const [db, setDb] = useState(null);
    const [tables, setTables] = useState([]);
    const [table, setTable] = useState(null);
    const [data, setData] = useState(null);
    const [search, setSearch] = useState('');
    const [loading, setLoading] = useState(false);
    const dbs = ['meta', 've', 'trade', 'education', 'business', 'clarity', 'corpus', 'taoist', 'work'];
    
    const loadTables = async (d) => {
        setLoading(true); setDb(d); setTable(null); setData(null);
        try { const r = await fetch(`${API}/api/v1/db/${d}/tables`); const j = await r.json(); setTables(j.tables || []); } catch (e) {}
        setLoading(false);
    };
    const loadData = async (t) => {
        setLoading(true); setTable(t);
        try { const r = await fetch(`${API}/api/v1/db/${db}/table/${t}?limit=20`); const j = await r.json(); setData(j); } catch (e) {}
        setLoading(false);
    };
    const filtered = tables.filter(t => t.toLowerCase().includes(search.toLowerCase()));
    
    return (
        <div className="space-y-4">
            <h1 className="text-2xl font-bold">ğŸ—„ï¸ è³‡æ–™åº«ç€è¦½å™¨</h1>
            <div className="flex flex-wrap gap-2">
                {dbs.map(d => (
                    <button key={d} onClick={() => loadTables(d)} className={`px-3 py-1.5 rounded-lg text-sm ${db === d ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}>{d}</button>
                ))}
            </div>
            {db && (
                <div className="grid lg:grid-cols-4 gap-4">
                    <div className="card rounded-xl p-4 border border-slate-700">
                        <input type="text" placeholder="æœå°‹è¡¨..." value={search} onChange={e => setSearch(e.target.value)} className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-sm mb-3" />
                        <div className="text-sm text-slate-400 mb-2">{db}.db ({filtered.length})</div>
                        <div className="space-y-1 max-h-[400px] overflow-y-auto">
                            {filtered.map(t => (
                                <button key={t} onClick={() => loadData(t)} className={`w-full text-left px-2 py-1.5 rounded text-sm truncate ${table === t ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>{t}</button>
                            ))}
                        </div>
                    </div>
                    <div className="lg:col-span-3 card rounded-xl p-4 border border-slate-700">
                        {loading ? <Loading /> : data ? (
                            <div className="fade-in">
                                <div className="flex justify-between mb-3">
                                    <span className="font-semibold text-blue-400">{table}</span>
                                    <span className="text-sm text-slate-500">{data.pagination?.total?.toLocaleString()} ç­†</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead><tr className="border-b border-slate-700">{data.columns?.slice(0, 5).map(c => <th key={c} className="text-left p-2 text-slate-400">{c}</th>)}</tr></thead>
                                        <tbody>{data.data?.map((r, i) => <tr key={i} className="border-b border-slate-800">{data.columns?.slice(0, 5).map(c => <td key={c} className="p-2 max-w-[200px] truncate">{String(r[c] ?? '').substring(0, 50)}</td>)}</tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                        ) : <div className="text-center text-slate-500 py-16">â† é¸æ“‡è¡¨</div>}
                    </div>
                </div>
            )}
        </div>
    );
};

// === App ===
const App = () => {
    const [page, setPage] = useState('home');
    return (
        <div className="min-h-screen">
            <Navbar page={page} setPage={setPage} />
            <main className="max-w-6xl mx-auto px-4 py-6">
                {page === 'home' && <Home setPage={setPage} />}
                {page === 'edu' && <Education />}
                {page === 've' && <VirtualEarth />}
                {page === 'db' && <Database />}
            </main>
            <footer className="text-center py-4 text-slate-500 text-sm border-t border-slate-800">
                <p>VE-System v1.0 | åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½æœ‰é™å…¬å¸ | é“çš„1%åŸå‰‡ Â· æ—¥æ‹±ä¸€å’</p>
            </footer>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>