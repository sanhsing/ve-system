<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VE-System è™›æ“¾åœ°çƒç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .card-glow { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        .star-glow { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .bounce { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .fade-in { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        const API_BASE = 'https://ve-system.onrender.com';
        
        // ============ é€šç”¨çµ„ä»¶ ============
        
        const Loading = () => (
            <div className="flex items-center justify-center p-8">
                <div className="loading-spin text-4xl">âš™ï¸</div>
                <span className="ml-3 text-gray-400">è¼‰å…¥ä¸­...</span>
            </div>
        );
        
        const StatCard = ({ title, value, subtitle, icon }) => (
            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700 hover:border-indigo-500 transition-all">
                <div className="flex items-center justify-between">
                    <div>
                        <p className="text-gray-400 text-sm">{title}</p>
                        <p className="text-3xl font-bold mt-1">{value}</p>
                        {subtitle && <p className="text-gray-500 text-sm mt-1">{subtitle}</p>}
                    </div>
                    <div className="text-4xl opacity-80">{icon}</div>
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-gray-800 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-gray-600 fade-in" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div className="p-4">{children}</div>
                    </div>
                </div>
            );
        };
        
        const Navbar = ({ currentPage, setCurrentPage }) => {
            const navItems = [
                { id: 'dashboard', name: 'å„€è¡¨æ¿', icon: 'ğŸ“Š' },
                { id: 'qixing', name: 'åŒ—æ–—ä¸ƒæ˜Ÿ', icon: 'â­' },
                { id: 'databases', name: 'è³‡æ–™åº«', icon: 'ğŸ—„ï¸' },
                { id: 'trade', name: 'äº¤æ˜“ç³»çµ±', icon: 'ğŸ“ˆ' },
                { id: 'education', name: 'æ•™è‚²ç³»çµ±', icon: 'ğŸ“š' },
                { id: 've', name: 'è™›æ“¬åœ°çƒ', icon: 'ğŸŒ' },
            ];
            
            return (
                <nav className="bg-gray-900/50 backdrop-blur-md border-b border-gray-700 sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center space-x-2 cursor-pointer" onClick={() => setCurrentPage('dashboard')}>
                                <span className="text-2xl">ğŸŒŒ</span>
                                <span className="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                                    VE-System
                                </span>
                            </div>
                            <div className="flex space-x-1 overflow-x-auto">
                                {navItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setCurrentPage(item.id)}
                                        className={`px-3 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${
                                            currentPage === item.id ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700'
                                        }`}
                                    >
                                        <span className="mr-1">{item.icon}</span>
                                        <span className="hidden md:inline">{item.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </nav>
            );
        };
        
        // ============ å„€è¡¨æ¿ ============
        
        const Dashboard = () => {
            const [status, setStatus] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                fetch(`${API_BASE}/api/v1/status`)
                    .then(res => res.json())
                    .then(data => { setStatus(data); setLoading(false); })
                    .catch(() => setLoading(false));
            }, []);
            
            if (loading) return <Loading />;
            
            return (
                <div className="space-y-6">
                    <div className="text-center py-8">
                        <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                            è™›æ“¾åœ°çƒç³»çµ±
                        </h1>
                        <p className="text-gray-400 mt-2">Virtual Earth System</p>
                        <div className="mt-4 inline-flex items-center px-4 py-2 bg-green-900/50 rounded-full border border-green-500">
                            <span className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            <span className="text-green-400">ç³»çµ±é‹è¡Œä¸­</span>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="ç³»çµ±æˆç†Ÿåº¦" value={status?.maturity || '90.7%'} subtitle="ç”¢å“ç´š" icon="ğŸ¯" />
                        <StatCard title="è³‡æ–™åº«" value={status?.totals?.databases || 9} subtitle="ä¹å®®æ ¼å±€" icon="ğŸ—„ï¸" />
                        <StatCard title="è³‡æ–™è¡¨" value={status?.totals?.tables?.toLocaleString()} subtitle="çµæ§‹å®Œæ•´" icon="ğŸ“‹" />
                        <StatCard title="è³‡æ–™ç­†æ•¸" value={status?.totals?.records?.toLocaleString()} subtitle="æŒçºŒç´¯ç©" icon="ğŸ“Š" />
                    </div>
                    
                    <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
                        <h2 className="text-xl font-semibold mb-4">ğŸ—„ï¸ ä¹åº«çµ±è¨ˆ</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {status?.databases && Object.entries(status.databases)
                                .sort((a, b) => (b[1].records || 0) - (a[1].records || 0))
                                .map(([name, db]) => (
                                <div key={name} className="bg-gray-900/50 rounded-lg p-4 border border-gray-600 hover:border-indigo-500 transition-all">
                                    <div className="flex justify-between items-center">
                                        <span className="font-medium text-indigo-400">{name}.db</span>
                                        <span className="text-xs text-gray-500">{db.tables} è¡¨</span>
                                    </div>
                                    <div className="mt-2">
                                        <div className="text-2xl font-bold">{(db.records || 0).toLocaleString()}</div>
                                        <div className="text-xs text-gray-500">ç­†è³‡æ–™</div>
                                    </div>
                                    <div className="mt-2 bg-gray-700 rounded-full h-2">
                                        <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full progress-bar"
                                            style={{ width: `${Math.min((db.records || 0) / 1500, 100)}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============ åŒ—æ–—ä¸ƒæ˜Ÿ ============
        
        const QiXing = () => {
            const [qixing, setQixing] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedStar, setSelectedStar] = useState(null);
            
            useEffect(() => {
                fetch(`${API_BASE}/api/v1/qixing`)
                    .then(res => res.json())
                    .then(data => { setQixing(data); setLoading(false); })
                    .catch(() => setLoading(false));
            }, []);
            
            if (loading) return <Loading />;
            
            const starDetails = {
                'å…‰è˜Š': { desc: 'æŒç®¡ç³»çµ±é¡˜æ™¯èˆ‡æ ¸å¿ƒåƒ¹å€¼ï¼Œç¢ºä¿æ‰€æœ‰æ±ºç­–ç¬¦åˆé“çš„åŸå‰‡', color: 'from-yellow-400 to-orange-500' },
                'ç¹”æ˜': { desc: 'è² è²¬ç³»çµ±æ¶æ§‹è¨­è¨ˆï¼Œç·¨ç¹”å„æ¨¡çµ„é–“çš„é€£çµèˆ‡é—œä¿‚', color: 'from-blue-400 to-cyan-500' },
                'ç†æ¨': { desc: 'è™•ç†é‚è¼¯é‹ç®—èˆ‡æ¼”ç®—æ³•ï¼Œæ˜¯ç³»çµ±çš„æ™ºæ…§æ ¸å¿ƒ', color: 'from-purple-400 to-pink-500' },
                'æ¾„æ›¸': { desc: 'æ²‰æ¾±çŸ¥è­˜èˆ‡æ–‡æª”ï¼Œå»ºç«‹ç³»çµ±çš„è¨˜æ†¶èˆ‡å‚³æ‰¿', color: 'from-green-400 to-teal-500' },
                'æµç¥‡': { desc: 'å„ªåŒ–æµç¨‹èˆ‡æ•ˆç‡ï¼Œç¢ºä¿ç³»çµ±é †æš¢é‹è¡Œ', color: 'from-red-400 to-rose-500' },
                'æ˜Ÿæ®¼': { desc: 'å‘ˆç¾ä½¿ç”¨è€…ä»‹é¢ï¼Œæ˜¯ç³»çµ±èˆ‡å¤–ç•Œçš„æ¥è§¸é¢', color: 'from-indigo-400 to-violet-500' },
                'ç’ƒèª': { desc: 'è™•ç†æºé€šèˆ‡ç¿»è­¯ï¼Œé€£æ¥ä¸åŒç³»çµ±èˆ‡ä½¿ç”¨è€…', color: 'from-amber-400 to-yellow-500' },
            };
            
            return (
                <div className="space-y-6">
                    <div className="text-center py-4">
                        <h1 className="text-3xl font-bold">â­ åŒ—æ–—ä¸ƒæ˜Ÿå”ä½œé«”ç³»</h1>
                        <p className="text-gray-400 mt-2">ä¸ƒæ˜Ÿå°é½Šç‡: {qixing?.alignment}</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h3 className="text-lg font-semibold mb-4">é¸æ“‡ä¸€é¡†æ˜Ÿ</h3>
                            <div className="grid grid-cols-2 gap-3">
                                {qixing?.stars?.map(star => (
                                    <button key={star.id} onClick={() => setSelectedStar(star)}
                                        className={`p-4 rounded-lg border transition-all text-left ${
                                            selectedStar?.id === star.id ? 'bg-indigo-600 border-indigo-400' : 'bg-gray-900/50 border-gray-600 hover:border-indigo-500'
                                        }`}>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-2xl star-glow">â­</span>
                                            <div>
                                                <div className="font-bold">{star.name}</div>
                                                <div className="text-sm text-gray-400">{star.role}</div>
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            {selectedStar ? (
                                <div className="space-y-4 fade-in">
                                    <div className={`text-center p-6 rounded-lg bg-gradient-to-r ${starDetails[selectedStar.name]?.color}`}>
                                        <div className="text-6xl mb-4">â­</div>
                                        <h2 className="text-2xl font-bold">{selectedStar.name}</h2>
                                        <p className="text-lg">{selectedStar.role}</p>
                                    </div>
                                    <div className="p-4 bg-gray-900/50 rounded-lg">
                                        <h4 className="font-semibold mb-2">è·è²¬èªªæ˜</h4>
                                        <p className="text-gray-400">{starDetails[selectedStar.name]?.desc}</p>
                                    </div>
                                    <div className="flex items-center justify-between p-4 bg-gray-900/50 rounded-lg">
                                        <span>ç‹€æ…‹</span>
                                        <span className="flex items-center text-green-400">
                                            <span className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>é‹è¡Œä¸­
                                        </span>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center text-gray-500 py-20">â† é»æ“Šé¸æ“‡ä¸€é¡†æ˜ŸæŸ¥çœ‹è©³æƒ…</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============ è³‡æ–™åº«ç€è¦½å™¨ ============
        
        const Databases = () => {
            const [selectedDb, setSelectedDb] = useState(null);
            const [tables, setTables] = useState([]);
            const [selectedTable, setSelectedTable] = useState(null);
            const [tableData, setTableData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            
            const databases = ['meta', 've', 'trade', 'education', 'business', 'clarity', 'corpus', 'taoist', 'work'];
            
            const loadTables = async (db) => {
                setLoading(true);
                setSelectedDb(db);
                setSelectedTable(null);
                setTableData(null);
                try {
                    const res = await fetch(`${API_BASE}/api/v1/db/${db}/tables`);
                    const data = await res.json();
                    setTables(data.tables || []);
                } catch (err) { console.error(err); }
                setLoading(false);
            };
            
            const loadTableData = async (table) => {
                setLoading(true);
                setSelectedTable(table);
                try {
                    const res = await fetch(`${API_BASE}/api/v1/db/${selectedDb}/table/${table}?limit=20`);
                    const data = await res.json();
                    setTableData(data);
                } catch (err) { console.error(err); }
                setLoading(false);
            };
            
            const filteredTables = tables.filter(t => t.toLowerCase().includes(searchTerm.toLowerCase()));
            
            return (
                <div className="space-y-6">
                    <h1 className="text-3xl font-bold">ğŸ—„ï¸ è³‡æ–™åº«ç€è¦½å™¨</h1>
                    <div className="flex flex-wrap gap-2">
                        {databases.map(db => (
                            <button key={db} onClick={() => loadTables(db)}
                                className={`px-4 py-2 rounded-lg transition-all ${selectedDb === db ? 'bg-indigo-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}>
                                {db}.db
                            </button>
                        ))}
                    </div>
                    
                    {selectedDb && (
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <input type="text" placeholder="æœå°‹è³‡æ–™è¡¨..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-sm focus:border-indigo-500 outline-none mb-3" />
                                <h3 className="font-semibold mb-2 text-indigo-400">{selectedDb}.db ({filteredTables.length} è¡¨)</h3>
                                <div className="space-y-1 max-h-[500px] overflow-y-auto">
                                    {filteredTables.map(table => (
                                        <button key={table} onClick={() => loadTableData(table)}
                                            className={`w-full text-left px-3 py-2 rounded text-sm transition-all ${selectedTable === table ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}>
                                            {table}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="lg:col-span-3 bg-gray-800/50 rounded-xl p-4 border border-gray-700 overflow-hidden">
                                {loading ? <Loading /> : tableData ? (
                                    <div className="fade-in">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="font-semibold text-indigo-400">{selectedTable}</h3>
                                            <span className="text-sm text-gray-500">å…± {tableData.pagination?.total?.toLocaleString()} ç­†</span>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead><tr className="border-b border-gray-700">
                                                    {tableData.columns?.slice(0, 6).map(col => (<th key={col} className="text-left p-2 text-gray-400 whitespace-nowrap">{col}</th>))}
                                                </tr></thead>
                                                <tbody>
                                                    {tableData.data?.map((row, i) => (
                                                        <tr key={i} className="border-b border-gray-800 hover:bg-gray-700/50">
                                                            {tableData.columns?.slice(0, 6).map(col => (
                                                                <td key={col} className="p-2 max-w-[200px] truncate">
                                                                    {typeof row[col] === 'object' ? JSON.stringify(row[col]).substring(0, 30) + '...' : String(row[col] ?? '').substring(0, 50)}
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ) : (<div className="text-center text-gray-500 py-20">â† é¸æ“‡ä¸€å€‹è³‡æ–™è¡¨æŸ¥çœ‹å…§å®¹</div>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ============ æ•™è‚²ç³»çµ± (åŠ å¼·ç‰ˆ) ============
        
        const Education = () => {
            const [mode, setMode] = useState('menu'); // menu, quiz, result
            const [questions, setQuestions] = useState([]);
            const [currentQ, setCurrentQ] = useState(0);
            const [selected, setSelected] = useState(null);
            const [result, setResult] = useState(null);
            const [score, setScore] = useState({ correct: 0, total: 0, streak: 0, maxStreak: 0 });
            const [loading, setLoading] = useState(false);
            const [subject, setSubject] = useState('all');
            const [difficulty, setDifficulty] = useState(10);
            const [history, setHistory] = useState([]);
            const [timeLeft, setTimeLeft] = useState(30);
            const [timerActive, setTimerActive] = useState(false);

            const subjects = [
                { id: 'all', name: 'å…¨éƒ¨ç§‘ç›®', icon: 'ğŸ“š' },
                { id: 'æ•¸å­¸', name: 'æ•¸å­¸', icon: 'ğŸ”¢' },
                { id: 'åœ‹æ–‡', name: 'åœ‹æ–‡', icon: 'ğŸ“–' },
                { id: 'è‹±æ–‡', name: 'è‹±æ–‡', icon: 'ğŸ”¤' },
                { id: 'ç†åŒ–', name: 'ç†åŒ–', icon: 'ğŸ”¬' },
                { id: 'ç¤¾æœƒ', name: 'ç¤¾æœƒ', icon: 'ğŸŒ' },
            ];

            useEffect(() => {
                if (timerActive && timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(t => t - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && timerActive) {
                    handleTimeout();
                }
            }, [timeLeft, timerActive]);

            const handleTimeout = () => {
                setTimerActive(false);
                setResult({ correct: false, correct_answer: questions[currentQ]?.answer, timeout: true });
                setScore(prev => ({ ...prev, total: prev.total + 1, streak: 0 }));
                setHistory(prev => [...prev, { ...questions[currentQ], correct: false, timeout: true }]);
            };
            
            const loadQuestions = async () => {
                setLoading(true);
                try {
                    const url = subject === 'all' 
                        ? `${API_BASE}/api/v1/education/questions?limit=${difficulty}`
                        : `${API_BASE}/api/v1/education/questions?limit=${difficulty}&subject=${subject}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    setQuestions(data.questions || []);
                    setCurrentQ(0);
                    setScore({ correct: 0, total: 0, streak: 0, maxStreak: 0 });
                    setSelected(null);
                    setResult(null);
                    setHistory([]);
                    setMode('quiz');
                    setTimeLeft(30);
                    setTimerActive(true);
                } catch (err) { console.error(err); }
                setLoading(false);
            };
            
            const checkAnswer = async (answer) => {
                if (result) return;
                setSelected(answer);
                setTimerActive(false);
                
                try {
                    const res = await fetch(`${API_BASE}/api/v1/education/check`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question_id: questions[currentQ].question_id, answer })
                    });
                    const data = await res.json();
                    setResult(data);
                    
                    const newStreak = data.correct ? score.streak + 1 : 0;
                    setScore(prev => ({
                        correct: prev.correct + (data.correct ? 1 : 0),
                        total: prev.total + 1,
                        streak: newStreak,
                        maxStreak: Math.max(prev.maxStreak, newStreak)
                    }));
                    setHistory(prev => [...prev, { ...questions[currentQ], correct: data.correct, userAnswer: answer }]);
                } catch (err) { console.error(err); }
            };
            
            const nextQuestion = () => {
                if (currentQ < questions.length - 1) {
                    setCurrentQ(prev => prev + 1);
                    setSelected(null);
                    setResult(null);
                    setTimeLeft(30);
                    setTimerActive(true);
                } else {
                    setMode('result');
                }
            };

            // ä¸»é¸å–®
            if (mode === 'menu') {
                return (
                    <div className="space-y-6">
                        <h1 className="text-3xl font-bold">ğŸ“š æ•™è‚²ç³»çµ±</h1>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                                <h2 className="text-xl font-semibold mb-4">ğŸ¯ é¸æ“‡ç§‘ç›®</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    {subjects.map(s => (
                                        <button key={s.id} onClick={() => setSubject(s.id)}
                                            className={`p-4 rounded-lg border transition-all ${subject === s.id ? 'bg-indigo-600 border-indigo-400' : 'bg-gray-900/50 border-gray-600 hover:border-indigo-500'}`}>
                                            <span className="text-2xl mr-2">{s.icon}</span>
                                            <span>{s.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                                <h2 className="text-xl font-semibold mb-4">ğŸ“Š é¡Œç›®æ•¸é‡</h2>
                                <div className="flex gap-3 mb-6">
                                    {[5, 10, 15, 20].map(n => (
                                        <button key={n} onClick={() => setDifficulty(n)}
                                            className={`px-6 py-3 rounded-lg border transition-all ${difficulty === n ? 'bg-green-600 border-green-400' : 'bg-gray-900/50 border-gray-600 hover:border-green-500'}`}>
                                            {n} é¡Œ
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="bg-gray-900/50 p-4 rounded-lg mb-4">
                                    <div className="flex justify-between text-sm text-gray-400 mb-2">
                                        <span>ç§‘ç›®: {subjects.find(s => s.id === subject)?.name}</span>
                                        <span>é¡Œæ•¸: {difficulty}</span>
                                    </div>
                                    <div className="flex justify-between text-sm text-gray-400">
                                        <span>æ™‚é–“é™åˆ¶: æ¯é¡Œ 30 ç§’</span>
                                        <span>æ¨¡å¼: æ¨™æº–æ¸¬é©—</span>
                                    </div>
                                </div>
                                
                                <button onClick={loadQuestions} disabled={loading}
                                    className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg font-bold text-lg transition-all">
                                    {loading ? 'è¼‰å…¥ä¸­...' : 'ğŸš€ é–‹å§‹æŒ‘æˆ°'}
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4">ğŸ† éŠæˆ²è¦å‰‡</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-gray-900/50 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">â±ï¸</div>
                                    <div className="font-semibold">è¨ˆæ™‚æŒ‘æˆ°</div>
                                    <div className="text-sm text-gray-400">æ¯é¡Œ 30 ç§’é™æ™‚</div>
                                </div>
                                <div className="bg-gray-900/50 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">ğŸ”¥</div>
                                    <div className="font-semibold">é€£çºŒç­”å°</div>
                                    <div className="text-sm text-gray-400">ç´¯ç©é€£å‹ç´€éŒ„</div>
                                </div>
                                <div className="bg-gray-900/50 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">ğŸ“</div>
                                    <div className="font-semibold">è©³ç´°è§£æ</div>
                                    <div className="text-sm text-gray-400">ç­”é¡Œå¾Œé¡¯ç¤ºèªªæ˜</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // æ¸¬é©—ä¸­
            if (mode === 'quiz') {
                const q = questions[currentQ];
                if (!q) return <Loading />;
                const options = Array.isArray(q.options) ? q.options : [];
                const progress = ((currentQ + 1) / questions.length) * 100;
                
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <button onClick={() => setMode('menu')} className="text-gray-400 hover:text-white">â† è¿”å›</button>
                            <div className="flex items-center space-x-4">
                                {score.streak >= 3 && <span className="text-orange-400">ğŸ”¥ {score.streak} é€£å‹!</span>}
                                <span className="text-green-400 font-bold">{score.correct}</span>
                                <span className="text-gray-500">/</span>
                                <span className="text-gray-400">{score.total}</span>
                            </div>
                        </div>
                        
                        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            {/* é€²åº¦æ¢ */}
                            <div className="mb-4">
                                <div className="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>é¡Œç›® {currentQ + 1} / {questions.length}</span>
                                    <span className={timeLeft <= 10 ? 'text-red-400' : ''}>{timeLeft}s</span>
                                </div>
                                <div className="bg-gray-700 rounded-full h-2">
                                    <div className="bg-indigo-500 h-2 rounded-full progress-bar" style={{ width: `${progress}%` }}></div>
                                </div>
                                <div className="bg-gray-700 rounded-full h-1 mt-1">
                                    <div className={`h-1 rounded-full progress-bar ${timeLeft <= 10 ? 'bg-red-500' : 'bg-green-500'}`} 
                                        style={{ width: `${(timeLeft / 30) * 100}%` }}></div>
                                </div>
                            </div>
                            
                            <div className="mb-2 text-sm text-indigo-400">{q.subject}</div>
                            <h2 className="text-xl mb-6">{q.question_text}</h2>
                            
                            <div className="space-y-3">
                                {options.map((opt, i) => {
                                    const letter = opt.charAt(0);
                                    const isSelected = selected === letter;
                                    const isCorrect = result?.correct_answer === letter;
                                    const isWrong = isSelected && !result?.correct;
                                    
                                    let btnClass = 'bg-gray-900/50 border-gray-600 hover:border-indigo-500';
                                    if (result) {
                                        if (isCorrect) btnClass = 'bg-green-900/50 border-green-500 bounce';
                                        else if (isWrong) btnClass = 'bg-red-900/50 border-red-500 shake';
                                    }
                                    
                                    return (
                                        <button key={i} onClick={() => checkAnswer(letter)} disabled={result !== null}
                                            className={`w-full text-left p-4 rounded-lg border transition-all ${btnClass}`}>
                                            {opt}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {result && (
                                <div className={`mt-6 p-4 rounded-lg fade-in ${result.correct ? 'bg-green-900/30 border border-green-600' : 'bg-red-900/30 border border-red-600'}`}>
                                    <div className="font-bold mb-2">
                                        {result.timeout ? 'â° æ™‚é–“åˆ°ï¼' : result.correct ? 'âœ… ç­”å°äº†ï¼' : `âŒ ç­”éŒ¯äº†`}
                                        {!result.correct && <span className="ml-2">æ­£ç¢ºç­”æ¡ˆæ˜¯ {result.correct_answer}</span>}
                                    </div>
                                    {q.explanation && <p className="text-gray-400 text-sm">{q.explanation}</p>}
                                </div>
                            )}
                            
                            {result && (
                                <button onClick={nextQuestion}
                                    className="mt-4 w-full py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold">
                                    {currentQ < questions.length - 1 ? 'ä¸‹ä¸€é¡Œ â†’' : 'æŸ¥çœ‹çµæœ ğŸ†'}
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // çµæœé 
            if (mode === 'result') {
                const percentage = Math.round((score.correct / score.total) * 100);
                const grade = percentage >= 90 ? 'S' : percentage >= 80 ? 'A' : percentage >= 70 ? 'B' : percentage >= 60 ? 'C' : 'D';
                const gradeColors = { S: 'text-yellow-400', A: 'text-green-400', B: 'text-blue-400', C: 'text-orange-400', D: 'text-red-400' };
                
                return (
                    <div className="space-y-6">
                        <div className="bg-gray-800/50 rounded-xl p-8 border border-gray-700 text-center">
                            <div className="text-6xl mb-4">ğŸ‰</div>
                            <h1 className="text-3xl font-bold mb-2">æŒ‘æˆ°å®Œæˆï¼</h1>
                            
                            <div className={`text-8xl font-bold my-6 ${gradeColors[grade]}`}>{grade}</div>
                            
                            <div className="grid grid-cols-3 gap-4 max-w-md mx-auto mb-6">
                                <div className="bg-gray-900/50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-green-400">{score.correct}</div>
                                    <div className="text-sm text-gray-500">ç­”å°</div>
                                </div>
                                <div className="bg-gray-900/50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold">{percentage}%</div>
                                    <div className="text-sm text-gray-500">æ­£ç¢ºç‡</div>
                                </div>
                                <div className="bg-gray-900/50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-orange-400">{score.maxStreak}</div>
                                    <div className="text-sm text-gray-500">æœ€é«˜é€£å‹</div>
                                </div>
                            </div>
                            
                            <div className="flex gap-4 justify-center">
                                <button onClick={() => setMode('menu')} className="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg">
                                    è¿”å›é¸å–®
                                </button>
                                <button onClick={loadQuestions} className="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg">
                                    å†ç©ä¸€æ¬¡
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4">ğŸ“‹ ç­”é¡Œç´€éŒ„</h2>
                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                {history.map((h, i) => (
                                    <div key={i} className={`p-3 rounded-lg flex items-start gap-3 ${h.correct ? 'bg-green-900/20' : 'bg-red-900/20'}`}>
                                        <span className="text-xl">{h.correct ? 'âœ…' : 'âŒ'}</span>
                                        <div className="flex-1">
                                            <div className="text-sm text-gray-400">{h.subject}</div>
                                            <div className="text-sm">{h.question_text?.substring(0, 60)}...</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }
        };
        
        // ============ äº¤æ˜“ç³»çµ± (åŠ å¼·ç‰ˆ) ============
        
        const Trade = () => {
            const [strategies, setStrategies] = useState([]);
            const [indicators, setIndicators] = useState([]);
            const [tab, setTab] = useState('strategies');
            const [loading, setLoading] = useState(true);
            const [selectedItem, setSelectedItem] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            
            useEffect(() => {
                Promise.all([
                    fetch(`${API_BASE}/api/v1/trade/strategies`).then(r => r.json()),
                    fetch(`${API_BASE}/api/v1/trade/indicators`).then(r => r.json())
                ]).then(([strat, ind]) => {
                    setStrategies(strat.strategies || []);
                    setIndicators(ind.indicators || []);
                    setLoading(false);
                }).catch(() => setLoading(false));
            }, []);

            const openDetail = (item, type) => {
                setSelectedItem({ ...item, type });
                setModalOpen(true);
            };
            
            if (loading) return <Loading />;
            
            return (
                <div className="space-y-6">
                    <h1 className="text-3xl font-bold">ğŸ“ˆ äº¤æ˜“ç³»çµ±</h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <StatCard title="ç­–ç•¥æ•¸" value={strategies.length} icon="ğŸ“Š" />
                        <StatCard title="æŠ€è¡“æŒ‡æ¨™" value={indicators.length} icon="ğŸ“‰" />
                        <StatCard title="å›æ¸¬å®Œæˆ" value="5" subtitle="å¥—ç­–ç•¥" icon="ğŸ§ª" />
                        <StatCard title="ç³»çµ±ç‹€æ…‹" value="90.2%" subtitle="æˆç†Ÿåº¦" icon="ğŸ¯" />
                    </div>
                    
                    <div className="flex space-x-2">
                        <button onClick={() => setTab('strategies')} 
                            className={`px-4 py-2 rounded-lg ${tab === 'strategies' ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                            ğŸ“Š ç­–ç•¥åº« ({strategies.length})
                        </button>
                        <button onClick={() => setTab('indicators')} 
                            className={`px-4 py-2 rounded-lg ${tab === 'indicators' ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                            ğŸ“‰ æŠ€è¡“æŒ‡æ¨™ ({indicators.length})
                        </button>
                    </div>
                    
                    {tab === 'strategies' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {strategies.map((s, i) => (
                                <div key={i} onClick={() => openDetail(s, 'strategy')}
                                    className="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-indigo-500 transition-all cursor-pointer">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-indigo-400">{s.strategy_name || s.name}</h3>
                                        <span className="text-xs px-2 py-1 bg-indigo-900/50 text-indigo-400 rounded">{s.category || 'ç­–ç•¥'}</span>
                                    </div>
                                    <p className="text-sm text-gray-400 mt-2">{s.description?.substring(0, 80)}...</p>
                                    <div className="mt-3 flex flex-wrap gap-2">
                                        {s.risk_level && <span className="px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded text-xs">é¢¨éšª: {s.risk_level}</span>}
                                        {s.timeframe && <span className="px-2 py-1 bg-blue-900/50 text-blue-400 rounded text-xs">{s.timeframe}</span>}
                                    </div>
                                    <div className="mt-2 text-right text-xs text-gray-500">é»æ“ŠæŸ¥çœ‹è©³æƒ… â†’</div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {tab === 'indicators' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {indicators.map((ind, i) => (
                                <div key={i} onClick={() => openDetail(ind, 'indicator')}
                                    className="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-green-500 transition-all cursor-pointer">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-green-400">{ind.indicator_name || ind.name}</h3>
                                        <span className="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded">{ind.category}</span>
                                    </div>
                                    {ind.formula && <code className="block mt-2 text-xs bg-gray-900 p-2 rounded overflow-x-auto">{ind.formula?.substring(0, 50)}...</code>}
                                    <div className="mt-2 text-right text-xs text-gray-500">é»æ“ŠæŸ¥çœ‹è©³æƒ… â†’</div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} 
                        title={selectedItem?.type === 'strategy' ? 'ğŸ“Š ç­–ç•¥è©³æƒ…' : 'ğŸ“‰ æŒ‡æ¨™è©³æƒ…'}>
                        {selectedItem && (
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold text-indigo-400">
                                    {selectedItem.strategy_name || selectedItem.indicator_name || selectedItem.name}
                                </h3>
                                
                                {selectedItem.description && (
                                    <div>
                                        <h4 className="font-semibold text-gray-400 mb-1">èªªæ˜</h4>
                                        <p>{selectedItem.description}</p>
                                    </div>
                                )}
                                
                                {selectedItem.formula && (
                                    <div>
                                        <h4 className="font-semibold text-gray-400 mb-1">å…¬å¼</h4>
                                        <code className="block bg-gray-900 p-3 rounded text-sm overflow-x-auto">{selectedItem.formula}</code>
                                    </div>
                                )}

                                {selectedItem.parameters && (
                                    <div>
                                        <h4 className="font-semibold text-gray-400 mb-1">åƒæ•¸</h4>
                                        <p className="text-sm">{selectedItem.parameters}</p>
                                    </div>
                                )}

                                {selectedItem.interpretation && (
                                    <div>
                                        <h4 className="font-semibold text-gray-400 mb-1">è§£è®€æ–¹å¼</h4>
                                        <p className="text-sm">{selectedItem.interpretation}</p>
                                    </div>
                                )}

                                {selectedItem.signal_rules && (
                                    <div>
                                        <h4 className="font-semibold text-gray-400 mb-1">ä¿¡è™Ÿè¦å‰‡</h4>
                                        <p className="text-sm">{selectedItem.signal_rules}</p>
                                    </div>
                                )}
                                
                                <div className="flex flex-wrap gap-2 pt-2">
                                    {selectedItem.category && <span className="px-3 py-1 bg-gray-700 rounded">{selectedItem.category}</span>}
                                    {selectedItem.risk_level && <span className="px-3 py-1 bg-yellow-900/50 text-yellow-400 rounded">é¢¨éšª: {selectedItem.risk_level}</span>}
                                    {selectedItem.timeframe && <span className="px-3 py-1 bg-blue-900/50 text-blue-400 rounded">{selectedItem.timeframe}</span>}
                                </div>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };
        
        // ============ è™›æ“¬åœ°çƒ (åŠ å¼·ç‰ˆ) ============
        
        const VirtualEarth = () => {
            const [quests, setQuests] = useState([]);
            const [shop, setShop] = useState([]);
            const [npcs, setNpcs] = useState([]);
            const [tab, setTab] = useState('quests');
            const [loading, setLoading] = useState(true);
            const [selectedQuest, setSelectedQuest] = useState(null);
            const [player, setPlayer] = useState({ gold: 1000, exp: 0, level: 1, inventory: [] });
            const [modalOpen, setModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState(null);
            
            useEffect(() => {
                Promise.all([
                    fetch(`${API_BASE}/api/v1/ve/quests`).then(r => r.json()),
                    fetch(`${API_BASE}/api/v1/ve/shop`).then(r => r.json()),
                    fetch(`${API_BASE}/api/v1/ve/npcs`).then(r => r.json())
                ]).then(([q, s, n]) => {
                    setQuests(q.quests || []);
                    setShop(s.items || []);
                    setNpcs(n.npcs || []);
                    setLoading(false);
                }).catch(() => setLoading(false));
            }, []);

            const startQuest = (quest) => {
                setModalContent({ type: 'quest', data: quest });
                setModalOpen(true);
            };

            const completeQuest = (quest) => {
                setPlayer(prev => ({
                    ...prev,
                    gold: prev.gold + (quest.gold_reward || 0),
                    exp: prev.exp + (quest.exp_reward || 0),
                    level: Math.floor((prev.exp + quest.exp_reward) / 500) + 1
                }));
                setModalContent({ type: 'reward', data: quest });
            };

            const buyItem = (item) => {
                if (player.gold >= item.price) {
                    setPlayer(prev => ({
                        ...prev,
                        gold: prev.gold - item.price,
                        inventory: [...prev.inventory, item.item_name]
                    }));
                    setModalContent({ type: 'purchase', data: item });
                    setModalOpen(true);
                } else {
                    setModalContent({ type: 'error', message: 'é‡‘å¹£ä¸è¶³ï¼' });
                    setModalOpen(true);
                }
            };

            const talkToNpc = (npc) => {
                setModalContent({ type: 'npc', data: npc });
                setModalOpen(true);
            };
            
            if (loading) return <Loading />;
            
            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h1 className="text-3xl font-bold">ğŸŒ è™›æ“¬åœ°çƒ - E18K é˜²è©éŠæˆ²</h1>
                    </div>

                    {/* ç©å®¶ç‹€æ…‹ */}
                    <div className="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-xl p-4 border border-indigo-500">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-2xl">ğŸ§™</div>
                                <div>
                                    <div className="text-sm text-gray-400">å†’éšªè€…</div>
                                    <div className="font-bold">Lv.{player.level}</div>
                                </div>
                            </div>
                            <div className="flex gap-6">
                                <div className="text-center">
                                    <div className="text-yellow-400 font-bold">ğŸ’° {player.gold}</div>
                                    <div className="text-xs text-gray-500">é‡‘å¹£</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-green-400 font-bold">â­ {player.exp}</div>
                                    <div className="text-xs text-gray-500">ç¶“é©—å€¼</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-blue-400 font-bold">ğŸ’ {player.inventory.length}</div>
                                    <div className="text-xs text-gray-500">ç‰©å“</div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-3 bg-gray-700 rounded-full h-2">
                            <div className="bg-gradient-to-r from-green-400 to-blue-400 h-2 rounded-full progress-bar" 
                                style={{ width: `${(player.exp % 500) / 5}%` }}></div>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">å‡ç´šé€²åº¦: {player.exp % 500} / 500</div>
                    </div>
                    
                    <div className="flex space-x-2">
                        <button onClick={() => setTab('quests')} className={`px-4 py-2 rounded-lg ${tab === 'quests' ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                            ğŸ¯ ä»»å‹™ ({quests.length})
                        </button>
                        <button onClick={() => setTab('shop')} className={`px-4 py-2 rounded-lg ${tab === 'shop' ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                            ğŸª å•†åº— ({shop.length})
                        </button>
                        <button onClick={() => setTab('npcs')} className={`px-4 py-2 rounded-lg ${tab === 'npcs' ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                            ğŸ‘¥ NPC ({npcs.length})
                        </button>
                    </div>
                    
                    {tab === 'quests' && (
                        <div className="space-y-4">
                            {quests.map((q, i) => (
                                <div key={i} className="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-indigo-500 transition-all">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <h3 className="font-bold text-indigo-400">{q.quest_id}: {q.quest_name}</h3>
                                                <span className={`text-xs px-2 py-1 rounded ${
                                                    q.difficulty === 'ç°¡å–®' ? 'bg-green-900/50 text-green-400' :
                                                    q.difficulty === 'ä¸­ç­‰' ? 'bg-yellow-900/50 text-yellow-400' :
                                                    q.difficulty === 'å›°é›£' ? 'bg-red-900/50 text-red-400' :
                                                    'bg-purple-900/50 text-purple-400'
                                                }`}>{q.difficulty}</span>
                                            </div>
                                            {q.description && <p className="text-sm text-gray-400 mt-1">{q.description}</p>}
                                        </div>
                                        <div className="text-right ml-4">
                                            <div className="text-yellow-400">ğŸ† {q.exp_reward} EXP</div>
                                            <div className="text-yellow-500">ğŸ’° {q.gold_reward} Gold</div>
                                            {q.item_reward && <div className="text-green-400 text-sm">ğŸ {q.item_reward}</div>}
                                        </div>
                                    </div>
                                    <div className="mt-3 flex gap-2">
                                        <button onClick={() => startQuest(q)} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm">
                                            é–‹å§‹ä»»å‹™
                                        </button>
                                        <button onClick={() => completeQuest(q)} className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
                                            æ¨¡æ“¬å®Œæˆ
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {tab === 'shop' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {shop.map((item, i) => (
                                <div key={i} className="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-yellow-500 transition-all">
                                    <div className="flex items-start gap-3">
                                        <div className="text-3xl">{
                                            item.item_name?.includes('è—¥æ°´') ? 'ğŸ§ª' :
                                            item.item_name?.includes('åŠ') ? 'âš”ï¸' :
                                            item.item_name?.includes('ç›¾') ? 'ğŸ›¡ï¸' :
                                            item.item_name?.includes('æ›¸') ? 'ğŸ“–' : 'ğŸ“¦'
                                        }</div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-yellow-400">{item.item_name}</h3>
                                            <p className="text-sm text-gray-400 mt-1">{item.description}</p>
                                        </div>
                                    </div>
                                    <div className="mt-3 flex justify-between items-center">
                                        <span className="text-yellow-500 font-bold">ğŸ’° {item.price} Gold</span>
                                        <button onClick={() => buyItem(item)}
                                            className={`px-4 py-2 rounded text-sm ${player.gold >= item.price ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 cursor-not-allowed'}`}
                                            disabled={player.gold < item.price}>
                                            {player.gold >= item.price ? 'è³¼è²·' : 'é‡‘å¹£ä¸è¶³'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'npcs' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {npcs.map((npc, i) => (
                                <div key={i} onClick={() => talkToNpc(npc)}
                                    className="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-blue-500 transition-all cursor-pointer">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-2xl">
                                            {npc.npc_id?.includes('GUIDE') ? 'ğŸ§™' :
                                             npc.npc_id?.includes('MERCHANT') ? 'ğŸ›’' :
                                             npc.npc_id?.includes('SAGE') ? 'ğŸ“š' : 'ğŸ‘¤'}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-blue-400">{npc.npc_name || npc.npc_id}</h3>
                                            <p className="text-sm text-gray-400">{npc.dialogue_text?.substring(0, 50)}...</p>
                                        </div>
                                    </div>
                                    <div className="mt-2 text-right text-xs text-gray-500">é»æ“Šå°è©± â†’</div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={
                        modalContent?.type === 'quest' ? 'ğŸ¯ ä»»å‹™è©³æƒ…' :
                        modalContent?.type === 'reward' ? 'ğŸ‰ ä»»å‹™å®Œæˆï¼' :
                        modalContent?.type === 'purchase' ? 'ğŸ›’ è³¼è²·æˆåŠŸï¼' :
                        modalContent?.type === 'npc' ? 'ğŸ’¬ å°è©±' :
                        'æç¤º'
                    }>
                        {modalContent?.type === 'quest' && (
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold">{modalContent.data.quest_name}</h3>
                                <p className="text-gray-400">{modalContent.data.description || 'å®Œæˆé€™å€‹ä»»å‹™ä¾†ç²å–çå‹µï¼'}</p>
                                <div className="bg-gray-900/50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-500 mb-2">çå‹µ</div>
                                    <div className="flex gap-4">
                                        <span className="text-yellow-400">ğŸ† {modalContent.data.exp_reward} EXP</span>
                                        <span className="text-yellow-500">ğŸ’° {modalContent.data.gold_reward} Gold</span>
                                    </div>
                                    {modalContent.data.item_reward && (
                                        <div className="text-green-400 mt-2">ğŸ {modalContent.data.item_reward}</div>
                                    )}
                                </div>
                            </div>
                        )}
                        {modalContent?.type === 'reward' && (
                            <div className="text-center space-y-4">
                                <div className="text-6xl">ğŸ‰</div>
                                <p>æ­å–œå®Œæˆä»»å‹™ï¼</p>
                                <div className="flex justify-center gap-4">
                                    <span className="text-yellow-400 text-xl">+{modalContent.data.exp_reward} EXP</span>
                                    <span className="text-yellow-500 text-xl">+{modalContent.data.gold_reward} Gold</span>
                                </div>
                            </div>
                        )}
                        {modalContent?.type === 'purchase' && (
                            <div className="text-center space-y-4">
                                <div className="text-6xl">âœ…</div>
                                <p>æˆåŠŸè³¼è²· <span className="text-yellow-400">{modalContent.data.item_name}</span>ï¼</p>
                                <p className="text-gray-400">ç‰©å“å·²åŠ å…¥èƒŒåŒ…</p>
                            </div>
                        )}
                        {modalContent?.type === 'npc' && (
                            <div className="space-y-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-3xl">ğŸ§™</div>
                                    <div>
                                        <div className="font-bold text-blue-400">{modalContent.data.npc_name || modalContent.data.npc_id}</div>
                                    </div>
                                </div>
                                <div className="bg-gray-900/50 p-4 rounded-lg">
                                    <p>{modalContent.data.dialogue_text}</p>
                                </div>
                            </div>
                        )}
                        {modalContent?.type === 'error' && (
                            <div className="text-center">
                                <div className="text-6xl mb-4">ğŸ˜¢</div>
                                <p className="text-red-400">{modalContent.message}</p>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };
        
        // ============ ä¸»æ‡‰ç”¨ ============
        
        const App = () => {
            const [currentPage, setCurrentPage] = useState('dashboard');
            
            const renderPage = () => {
                switch (currentPage) {
                    case 'dashboard': return <Dashboard />;
                    case 'qixing': return <QiXing />;
                    case 'databases': return <Databases />;
                    case 'trade': return <Trade />;
                    case 'education': return <Education />;
                    case 've': return <VirtualEarth />;
                    default: return <Dashboard />;
                }
            };
            
            return (
                <div className="min-h-screen">
                    <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
                    <main className="max-w-7xl mx-auto px-4 py-8">{renderPage()}</main>
                    <footer className="text-center py-6 text-gray-500 text-sm border-t border-gray-800">
                        <p>VE-System v1.0.0 | åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½æœ‰é™å…¬å¸</p>
                        <p className="mt-1">é“çš„1%åŸå‰‡ Â· æ—¥æ‹±ä¸€å’</p>
                    </footer>
                </div>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
