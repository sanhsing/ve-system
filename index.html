<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VE-System è™›æ“¾åœ°çƒç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <style>
        body{font-family:system-ui,-apple-system,sans-serif}
        .gradient-bg{background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%)}
        .spin{animation:spin 1s linear infinite}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .shake{animation:shake .5s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .bounce{animation:bounce .5s}
        @keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .fade{animation:fade .3s}
        @keyframes fade{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        .card{background:rgba(30,41,59,.9);backdrop-filter:blur(10px)}
        .bar{transition:width .3s}
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,createContext,useContext,useCallback}=React;
const{BarChart,Bar,XAxis,YAxis,Tooltip,ResponsiveContainer,LineChart,Line,PieChart,Pie,Cell}=Recharts;

const API='https://ve-system.onrender.com';

// ============ ç°¡æ˜“ç‹€æ…‹ç®¡ç† ============
const createStore=(init)=>{
    let state=init;
    const listeners=new Set();
    return{
        get:()=>state,
        set:(p)=>{state={...state,...(typeof p==='function'?p(state):p)};listeners.forEach(l=>l(state));
            try{localStorage.setItem('ve-store',JSON.stringify({user:state.user,token:state.token,local:state.local}));}catch(e){}},
        sub:(l)=>{listeners.add(l);return()=>listeners.delete(l);}
    };
};

const store=createStore({
    user:null,token:null,isAuth:false,
    local:{exp:0,gold:500,level:1,hp:100,maxHp:100,completed:[],history:[]}
});

// è¼‰å…¥æœ¬åœ°å­˜å„²
try{
    const saved=JSON.parse(localStorage.getItem('ve-store')||'{}');
    if(saved.token)store.set({user:saved.user,token:saved.token,isAuth:true,local:saved.local||store.get().local});
}catch(e){}

const useStore=()=>{const[s,setS]=useState(store.get());useEffect(()=>store.sub(setS),[]);return{...s,set:store.set};};

// ============ API ============
const api={
    async req(url,opt={}){
        const t=store.get().token;
        const h={'Content-Type':'application/json',...opt.headers};
        if(t)h['X-Token']=t;
        const r=await fetch(`${API}${url}`,{...opt,headers:h});
        const d=await r.json();
        if(!r.ok)throw{status:r.status,...d};
        return d;
    },
    get:u=>api.req(u),
    post:(u,b)=>api.req(u,{method:'POST',body:JSON.stringify(b)}),
};

// ============ å…±ç”¨å…ƒä»¶ ============
const Loading=()=><div className="flex justify-center items-center p-12"><div className="spin text-4xl">âš™ï¸</div></div>;

const Modal=({open,onClose,title,children,wide})=>{
    if(!open)return null;
    return(
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className={`card rounded-2xl ${wide?'max-w-4xl':'max-w-lg'} w-full max-h-[90vh] flex flex-col border border-slate-500 fade`} onClick={e=>e.stopPropagation()}>
                <div className="p-4 border-b border-slate-600 flex justify-between items-center shrink-0">
                    <h2 className="text-xl font-bold">{title}</h2>
                    <button onClick={onClose} className="w-10 h-10 bg-red-600 hover:bg-red-500 rounded-full flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>
                <div className="p-5 overflow-y-auto flex-1">{children}</div>
                <div className="p-4 border-t border-slate-600 shrink-0">
                    <button onClick={onClose} className="w-full py-3 bg-slate-600 hover:bg-slate-500 rounded-lg font-semibold">é—œé–‰</button>
                </div>
            </div>
        </div>
    );
};

const ProgressBar=({value,max,color='bg-blue-500',h='h-2'})=>(
    <div className={`${h} bg-slate-700 rounded-full overflow-hidden`}>
        <div className={`${h} ${color} bar rounded-full`} style={{width:`${Math.min(100,value/max*100)}%`}}/>
    </div>
);

// ============ å°èˆª ============
const Nav=({page,setPage})=>{
    const{user,isAuth,set}=useStore();
    const[menu,setMenu]=useState(false);
    
    const logout=()=>{api.post('/api/v1/auth/logout').catch(()=>{});set({user:null,token:null,isAuth:false});setMenu(false);};
    
    return(
        <nav className="bg-slate-900/95 backdrop-blur border-b border-slate-700 sticky top-0 z-40">
            <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setPage('home')}>
                    <span className="text-2xl">ğŸŒŒ</span>
                    <span className="font-bold hidden sm:inline">VE-System</span>
                </div>
                <div className="flex items-center gap-1">
                    {[{id:'home',i:'ğŸ ',n:'é¦–é '},{id:'edu',i:'ğŸ“š',n:'æ•™è‚²'},{id:'game',i:'ğŸ®',n:'éŠæˆ²'},{id:'stats',i:'ğŸ“Š',n:'åˆ†æ'}].map(x=>
                        <button key={x.id} onClick={()=>setPage(x.id)} className={`px-3 py-2 rounded-lg text-sm transition ${page===x.id?'bg-blue-600':'hover:bg-slate-700'}`} title={x.n}>{x.i}<span className="hidden md:inline ml-1">{x.n}</span></button>
                    )}
                    {isAuth?(
                        <div className="relative ml-2">
                            <button onClick={()=>setMenu(!menu)} className="flex items-center gap-2 px-3 py-1.5 bg-slate-700 rounded-lg hover:bg-slate-600">
                                <span>{user?.avatar||'ğŸ§™'}</span>
                                <span className="hidden sm:inline text-sm max-w-[80px] truncate">{user?.display_name}</span>
                            </button>
                            {menu&&(
                                <div className="absolute right-0 top-12 bg-slate-800 border border-slate-600 rounded-lg shadow-xl py-2 min-w-[140px] fade z-50">
                                    <div className="px-4 py-2 border-b border-slate-700">
                                        <div className="font-bold">{user?.display_name}</div>
                                        <div className="text-xs text-slate-400">Lv.{user?.level} Â· {user?.exp} EXP</div>
                                    </div>
                                    <button onClick={()=>{setPage('profile');setMenu(false);}} className="w-full px-4 py-2 text-left hover:bg-slate-700 text-sm">ğŸ‘¤ å€‹äººè³‡æ–™</button>
                                    <button onClick={()=>{setPage('stats');setMenu(false);}} className="w-full px-4 py-2 text-left hover:bg-slate-700 text-sm">ğŸ“Š å­¸ç¿’åˆ†æ</button>
                                    <button onClick={logout} className="w-full px-4 py-2 text-left hover:bg-slate-700 text-red-400 text-sm">ğŸšª ç™»å‡º</button>
                                </div>
                            )}
                        </div>
                    ):(
                        <button onClick={()=>setPage('login')} className="ml-2 px-4 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">ç™»å…¥</button>
                    )}
                </div>
            </div>
        </nav>
    );
};

// ============ ç™»å…¥/è¨»å†Š ============
const AuthPage=({setPage})=>{
    const{set}=useStore();
    const[mode,setMode]=useState('login');
    const[form,setForm]=useState({username:'',password:'',email:'',display_name:''});
    const[err,setErr]=useState('');
    const[loading,setLoading]=useState(false);
    
    const submit=async(e)=>{
        e.preventDefault();setErr('');setLoading(true);
        try{
            const d=await api.post(mode==='login'?'/api/v1/auth/login':'/api/v1/auth/register',form);
            set({user:d.user,token:d.token,isAuth:true});
            setPage('home');
        }catch(e){setErr(e.error||'æ“ä½œå¤±æ•—');}
        finally{setLoading(false);}
    };
    
    return(
        <div className="max-w-md mx-auto py-8">
            <div className="card rounded-2xl p-6 border border-slate-600">
                <div className="text-center mb-6">
                    <div className="text-5xl mb-2">ğŸŒŒ</div>
                    <h1 className="text-2xl font-bold">{mode==='login'?'ç™»å…¥':'è¨»å†Š'}</h1>
                </div>
                <div className="flex gap-2 mb-4">
                    <button onClick={()=>setMode('login')} className={`flex-1 py-2 rounded-lg ${mode==='login'?'bg-blue-600':'bg-slate-700'}`}>ç™»å…¥</button>
                    <button onClick={()=>setMode('register')} className={`flex-1 py-2 rounded-lg ${mode==='register'?'bg-blue-600':'bg-slate-700'}`}>è¨»å†Š</button>
                </div>
                {err&&<div className="bg-red-900/50 border border-red-600 text-red-400 p-3 rounded-lg mb-4 text-sm">{err}</div>}
                <form onSubmit={submit} className="space-y-4">
                    <input type="text" value={form.username} onChange={e=>setForm({...form,username:e.target.value})} className="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 outline-none" placeholder="ç”¨æˆ¶å" required/>
                    {mode==='register'&&<>
                        <input type="text" value={form.display_name} onChange={e=>setForm({...form,display_name:e.target.value})} className="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 outline-none" placeholder="é¡¯ç¤ºåç¨±"/>
                        <input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 outline-none" placeholder="Email (é¸å¡«)"/>
                    </>}
                    <input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 outline-none" placeholder="å¯†ç¢¼" required/>
                    <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold disabled:opacity-50">{loading?'è™•ç†ä¸­...':mode==='login'?'ç™»å…¥':'è¨»å†Š'}</button>
                </form>
            </div>
        </div>
    );
};

// ============ å€‹äººè³‡æ–™ ============
const ProfilePage=()=>{
    const{isAuth}=useStore();
    const[data,setData]=useState(null);
    const[loading,setLoading]=useState(true);
    
    useEffect(()=>{
        if(isAuth)api.get('/api/v1/user/profile').then(setData).catch(()=>{}).finally(()=>setLoading(false));
        else setLoading(false);
    },[isAuth]);
    
    if(!isAuth)return<div className="text-center py-12 text-slate-400">è«‹å…ˆç™»å…¥æŸ¥çœ‹å€‹äººè³‡æ–™</div>;
    if(loading)return<Loading/>;
    if(!data)return<div className="text-center py-12 text-red-400">è¼‰å…¥å¤±æ•—</div>;
    
    const{user:u,stats:s,today:t}=data;
    
    return(
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸ‘¤ å€‹äººè³‡æ–™</h1>
            <div className="card rounded-xl p-6 border border-slate-600">
                <div className="flex items-center gap-4">
                    <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-4xl">{u.avatar}</div>
                    <div>
                        <h2 className="text-xl font-bold">{u.display_name}</h2>
                        <p className="text-slate-400 text-sm">@{u.username}</p>
                        <div className="flex gap-3 mt-1 text-sm">
                            <span className="text-yellow-400">Lv.{u.level}</span>
                            <span className="text-green-400">{u.exp} EXP</span>
                            <span className="text-yellow-500">ğŸ’°{u.gold}</span>
                        </div>
                    </div>
                </div>
                <div className="mt-4 space-y-2">
                    <div><span className="text-xs text-slate-500">ç¶“é©—å€¼</span><ProgressBar value={u.exp%300} max={u.level*300} color="bg-green-500"/></div>
                    <div><span className="text-xs text-slate-500">HP</span><ProgressBar value={u.hp} max={u.max_hp} color="bg-red-500"/></div>
                </div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div className="card rounded-xl p-4 border border-slate-600 text-center"><div className="text-2xl font-bold text-blue-400">{s.total_answers}</div><div className="text-xs text-slate-500">ç¸½ç­”é¡Œ</div></div>
                <div className="card rounded-xl p-4 border border-slate-600 text-center"><div className="text-2xl font-bold text-green-400">{s.accuracy}%</div><div className="text-xs text-slate-500">æ­£ç¢ºç‡</div></div>
                <div className="card rounded-xl p-4 border border-slate-600 text-center"><div className="text-2xl font-bold text-yellow-400">{s.achievement_count}</div><div className="text-xs text-slate-500">æˆå°±</div></div>
                <div className="card rounded-xl p-4 border border-slate-600 text-center"><div className="text-2xl font-bold text-purple-400">{s.badge_count}</div><div className="text-xs text-slate-500">å¾½ç« </div></div>
            </div>
            <div className="card rounded-xl p-4 border border-slate-600">
                <h3 className="font-bold mb-3">ğŸ“… ä»Šæ—¥</h3>
                <div className="grid grid-cols-4 gap-2 text-center text-sm">
                    <div><div className="text-lg font-bold">{t.questions_answered}</div><div className="text-xs text-slate-500">ç­”é¡Œ</div></div>
                    <div><div className="text-lg font-bold text-green-400">{t.correct_count}</div><div className="text-xs text-slate-500">ç­”å°</div></div>
                    <div><div className="text-lg font-bold text-yellow-400">+{t.exp_gained}</div><div className="text-xs text-slate-500">EXP</div></div>
                    <div><div className="text-lg font-bold text-orange-400">{t.streak_count}</div><div className="text-xs text-slate-500">é€£å‹</div></div>
                </div>
            </div>
        </div>
    );
};

// ============ å­¸ç¿’åˆ†æ ============
const StatsPage=()=>{
    const{isAuth,local}=useStore();
    const[data,setData]=useState(null);
    const[loading,setLoading]=useState(true);
    
    useEffect(()=>{
        if(isAuth){
            api.get('/api/v1/analytics/overview').then(setData).catch(()=>{}).finally(()=>setLoading(false));
        }else{
            // æœ¬åœ°æ•¸æ“š
            const subj=local.history.reduce((a,h)=>{
                let s=a.find(x=>x.subject===h.subject);
                if(!s){s={subject:h.subject||'æœªåˆ†é¡',total:0,correct:0};a.push(s);}
                s.total++;if(h.correct)s.correct++;
                return a;
            },[]).map(s=>({...s,accuracy:s.total?Math.round(s.correct/s.total*100):0}));
            setData({by_subject:subj,daily_trend:[],weak_subjects:subj.filter(s=>s.accuracy<60).slice(0,3),best_streak:0});
            setLoading(false);
        }
    },[isAuth,local]);
    
    if(loading)return<Loading/>;
    
    const COLORS=['#3b82f6','#22c55e','#eab308','#ef4444','#a855f7','#06b6d4'];
    
    return(
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸ“Š å­¸ç¿’åˆ†æ</h1>
            {!isAuth&&<div className="bg-yellow-900/30 border border-yellow-600 p-3 rounded-lg text-sm text-yellow-400">âš ï¸ æœªç™»å…¥ï¼Œé¡¯ç¤ºæœ¬åœ°æ•¸æ“š</div>}
            
            <div className="card rounded-xl p-4 border border-slate-600">
                <h3 className="font-bold mb-3">ğŸ“š å„ç§‘æ­£ç¢ºç‡</h3>
                {data?.by_subject?.length>0?(
                    <div className="h-48">
                        <ResponsiveContainer>
                            <BarChart data={data.by_subject}>
                                <XAxis dataKey="subject" tick={{fill:'#94a3b8',fontSize:11}}/>
                                <YAxis tick={{fill:'#94a3b8',fontSize:11}} domain={[0,100]}/>
                                <Tooltip contentStyle={{background:'#1e293b',border:'1px solid #475569',borderRadius:8}}/>
                                <Bar dataKey="accuracy" fill="#3b82f6" radius={[4,4,0,0]}/>
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                ):<p className="text-slate-500 text-center py-8">é–‹å§‹ç­”é¡Œå¾Œé¡¯ç¤º</p>}
            </div>
            
            {data?.daily_trend?.length>0&&(
                <div className="card rounded-xl p-4 border border-slate-600">
                    <h3 className="font-bold mb-3">ğŸ“ˆ è¿‘7æ—¥è¶¨å‹¢</h3>
                    <div className="h-48">
                        <ResponsiveContainer>
                            <LineChart data={[...data.daily_trend].reverse()}>
                                <XAxis dataKey="date" tick={{fill:'#94a3b8',fontSize:11}} tickFormatter={d=>d?.slice(5)}/>
                                <YAxis tick={{fill:'#94a3b8',fontSize:11}}/>
                                <Tooltip contentStyle={{background:'#1e293b',border:'1px solid #475569',borderRadius:8}}/>
                                <Line type="monotone" dataKey="questions_answered" stroke="#3b82f6" strokeWidth={2} name="ç­”é¡Œæ•¸"/>
                                <Line type="monotone" dataKey="correct_count" stroke="#22c55e" strokeWidth={2} name="ç­”å°æ•¸"/>
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            )}
            
            {data?.weak_subjects?.length>0&&(
                <div className="card rounded-xl p-4 border border-red-500/30">
                    <h3 className="font-bold text-red-400 mb-3">âš ï¸ éœ€åŠ å¼·</h3>
                    <div className="space-y-2">
                        {data.weak_subjects.map((s,i)=>(
                            <div key={i} className="flex items-center justify-between">
                                <span className="text-sm">{s.subject}</span>
                                <div className="flex items-center gap-2">
                                    <div className="w-24"><ProgressBar value={s.accuracy} max={100} color="bg-red-500"/></div>
                                    <span className="text-red-400 text-sm w-10 text-right">{s.accuracy}%</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
            
            <div className="grid grid-cols-2 gap-4">
                <div className="card rounded-xl p-4 border border-slate-600 text-center">
                    <div className="text-4xl mb-1">ğŸ”¥</div>
                    <div className="text-2xl font-bold text-orange-400">{data?.best_streak||0}</div>
                    <div className="text-xs text-slate-500">æœ€é«˜é€£å‹</div>
                </div>
                <div className="card rounded-xl p-4 border border-slate-600 text-center">
                    <div className="text-4xl mb-1">ğŸ“</div>
                    <div className="text-2xl font-bold text-blue-400">{data?.by_subject?.reduce((s,x)=>s+x.total,0)||0}</div>
                    <div className="text-xs text-slate-500">ç¸½ç­”é¡Œ</div>
                </div>
            </div>
        </div>
    );
};

// ============ é¦–é  ============
const Home=({setPage})=>{
    const{isAuth,user,local}=useStore();
    const p=isAuth?user:local;
    
    return(
        <div className="space-y-6">
            <div className="text-center py-6">
                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">è™›æ“¾åœ°çƒç³»çµ±</h1>
                <p className="text-slate-400 text-sm mt-1">E18K é˜²è©æ•™è‚²éŠæˆ²å¹³å°</p>
            </div>
            
            <div className="card rounded-xl p-4 border border-slate-600">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-2xl">{isAuth?user?.avatar:'ğŸ§™'}</div>
                        <div>
                            <div className="font-bold">{isAuth?user?.display_name:'è¨ªå®¢'}</div>
                            <div className="text-xs text-slate-400">Lv.{p?.level||1}</div>
                        </div>
                    </div>
                    <div className="flex gap-4 text-sm">
                        <div className="text-center"><div className="font-bold text-green-400">{p?.exp||0}</div><div className="text-xs text-slate-500">EXP</div></div>
                        <div className="text-center"><div className="font-bold text-yellow-400">{p?.gold||500}</div><div className="text-xs text-slate-500">é‡‘å¹£</div></div>
                    </div>
                </div>
                {!isAuth&&<div className="mt-3 pt-3 border-t border-slate-700 text-center"><button onClick={()=>setPage('login')} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">ç™»å…¥ä»¥ä¿å­˜é€²åº¦</button></div>}
            </div>
            
            <div className="grid md:grid-cols-2 gap-4">
                {[
                    {id:'edu',i:'ğŸ“š',t:'æ•™è‚²ç³»çµ±',d:'108èª²ç¶± Â· çŸ¥è­˜æ¸¬é©—',c:'border-blue-500'},
                    {id:'game',i:'ğŸ®',t:'é˜²è©éŠæˆ²',d:'æƒ…å¢ƒæŒ‘æˆ° Â· æ€ªç‰©æ”¶é›†',c:'border-green-500'},
                    {id:'stats',i:'ğŸ“Š',t:'å­¸ç¿’åˆ†æ',d:'é€²åº¦è¿½è¹¤ Â· å¼±é»åˆ†æ',c:'border-purple-500'},
                    {id:'profile',i:'ğŸ‘¤',t:'å€‹äººä¸­å¿ƒ',d:'æˆå°±å¾½ç«  Â· æ’è¡Œæ¦œ',c:'border-yellow-500'},
                ].map(x=>(
                    <button key={x.id} onClick={()=>setPage(x.id)} className={`card rounded-xl p-5 border-2 border-slate-600 hover:${x.c} transition text-left group`}>
                        <div className="text-4xl mb-2 group-hover:scale-110 transition">{x.i}</div>
                        <h2 className="text-lg font-bold">{x.t}</h2>
                        <p className="text-slate-400 text-sm">{x.d}</p>
                    </button>
                ))}
            </div>
        </div>
    );
};

// ============ æ•™è‚²ç³»çµ± ============
const EduPage=()=>{
    const{isAuth,local,set}=useStore();
    const[state,setState]=useState('menu'); // menu, playing, result
    const[qs,setQs]=useState([]);
    const[idx,setIdx]=useState(0);
    const[ans,setAns]=useState(null);
    const[res,setRes]=useState(null);
    const[score,setScore]=useState({c:0,t:0,streak:0,max:0});
    const[timer,setTimer]=useState(30);
    
    useEffect(()=>{
        if(state==='playing'&&timer>0&&!res){
            const t=setTimeout(()=>setTimer(v=>v-1),1000);
            return()=>clearTimeout(t);
        }
        if(timer===0&&!res){
            setRes({correct:false,timeout:true,correct_answer:'?'});
            setScore(p=>({...p,t:p.t+1,streak:0}));
        }
    },[timer,state,res]);
    
    const start=async()=>{
        try{
            const d=await api.get('/api/v1/education/questions?limit=10');
            if(d.questions?.length){
                setQs(d.questions);setIdx(0);setScore({c:0,t:0,streak:0,max:0});
                setAns(null);setRes(null);setTimer(30);setState('playing');
            }
        }catch(e){alert('è¼‰å…¥å¤±æ•—');}
    };
    
    const submit=async(a)=>{
        if(res)return;
        setAns(a);
        try{
            const d=await api.post('/api/v1/education/check',{question_id:qs[idx].question_id,answer:a});
            setRes(d);
            const ns=d.correct?score.streak+1:0;
            setScore(p=>({c:p.c+(d.correct?1:0),t:p.t+1,streak:ns,max:Math.max(p.max,ns)}));
            if(!isAuth){
                const nl={...local};
                nl.exp+=d.correct?20:5;
                nl.gold+=d.correct?10:0;
                nl.level=Math.floor(nl.exp/300)+1;
                nl.history.push({subject:qs[idx].subject_id,correct:d.correct,ts:Date.now()});
                set({local:nl});
            }
        }catch(e){setRes({correct:false,error:true});}
    };
    
    const next=()=>{
        if(idx<qs.length-1){setIdx(i=>i+1);setAns(null);setRes(null);setTimer(30);}
        else setState('result');
    };
    
    if(state==='playing'){
        const q=qs[idx];if(!q)return<Loading/>;
        const opts=typeof q.options==='string'?JSON.parse(q.options):q.options||[];
        return(
            <div className="max-w-2xl mx-auto space-y-4">
                <button onClick={()=>setState('menu')} className="text-sm text-slate-400 hover:text-white">â† é€€å‡º</button>
                <div className="card rounded-xl p-5 border border-slate-600">
                    <div className="flex justify-between items-center mb-2 text-sm">
                        <span className="text-slate-400">{idx+1}/{qs.length}</span>
                        <div className="flex items-center gap-2">
                            {score.streak>=3&&<span className="text-orange-400">ğŸ”¥{score.streak}</span>}
                            <span className={timer<=10?'text-red-400 font-bold':''}>{timer}s</span>
                        </div>
                    </div>
                    <ProgressBar value={timer} max={30} color={timer<=10?'bg-red-500':'bg-green-500'}/>
                    <h2 className="text-lg mt-4 mb-4">{q.question_text}</h2>
                    <div className="space-y-2">
                        {opts.map((o,i)=>{
                            const l=o.charAt(0);
                            const isC=res?.correct_answer===l;
                            const isW=ans===l&&!res?.correct;
                            let cls='border-slate-600 hover:border-blue-500';
                            if(res){cls=isC?'border-green-500 bg-green-900/30':isW?'border-red-500 bg-red-900/30 shake':'opacity-50';}
                            return<button key={i} onClick={()=>submit(l)} disabled={!!res} className={`w-full text-left p-3 rounded-lg border-2 transition text-sm ${cls}`}><span className="font-bold text-blue-400 mr-2">{l}.</span>{o.substring(2)}</button>;
                        })}
                    </div>
                    {res&&(
                        <div className={`mt-4 p-3 rounded-lg text-sm ${res.correct?'bg-green-900/40 border border-green-600':'bg-red-900/40 border border-red-600'}`}>
                            <div className="font-bold">{res.timeout?'â° æ™‚é–“åˆ°':res.correct?'âœ… æ­£ç¢ºï¼':'âŒ éŒ¯èª¤'}{!res.correct&&<span className="ml-2 text-green-400">ç­”æ¡ˆ: {res.correct_answer}</span>}</div>
                        </div>
                    )}
                    {res&&<button onClick={next} className="w-full py-3 bg-blue-600 rounded-lg font-bold mt-4">{idx<qs.length-1?'ä¸‹ä¸€é¡Œ':'æŸ¥çœ‹çµæœ'}</button>}
                </div>
            </div>
        );
    }
    
    if(state==='result'){
        const pct=score.t?Math.round(score.c/score.t*100):0;
        const g=pct>=90?'S':pct>=80?'A':pct>=70?'B':pct>=60?'C':'D';
        const gc={S:'text-yellow-400',A:'text-green-400',B:'text-blue-400',C:'text-slate-400',D:'text-red-400'};
        return(
            <div className="max-w-sm mx-auto card rounded-xl p-6 border border-slate-600 text-center">
                <div className="text-4xl mb-2">ğŸ‰</div>
                <h2 className="text-xl font-bold mb-2">æ¸¬é©—å®Œæˆ</h2>
                <div className={`text-6xl font-bold mb-4 ${gc[g]}`}>{g}</div>
                <div className="grid grid-cols-3 gap-2 mb-4">
                    <div className="bg-slate-700 p-2 rounded-lg"><div className="text-xl font-bold text-green-400">{score.c}</div><div className="text-xs text-slate-500">ç­”å°</div></div>
                    <div className="bg-slate-700 p-2 rounded-lg"><div className="text-xl font-bold">{pct}%</div><div className="text-xs text-slate-500">æ­£ç¢ºç‡</div></div>
                    <div className="bg-slate-700 p-2 rounded-lg"><div className="text-xl font-bold text-orange-400">{score.max}</div><div className="text-xs text-slate-500">é€£å‹</div></div>
                </div>
                <div className="flex gap-2">
                    <button onClick={()=>setState('menu')} className="flex-1 py-2 bg-slate-600 rounded-lg">è¿”å›</button>
                    <button onClick={start} className="flex-1 py-2 bg-blue-600 rounded-lg">å†ç©</button>
                </div>
            </div>
        );
    }
    
    return(
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸ“š æ•™è‚²ç³»çµ±</h1>
            <div className="max-w-md mx-auto card rounded-xl p-6 border border-slate-600 text-center">
                <div className="text-5xl mb-3">ğŸ¯</div>
                <h2 className="text-xl font-bold mb-2">çŸ¥è­˜æ¸¬é©—</h2>
                <p className="text-slate-400 text-sm mb-4">æŒ‘æˆ° 10 é¡Œï¼Œæ¸¬è©¦ä½ çš„çŸ¥è­˜ï¼</p>
                <button onClick={start} className="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl font-bold">é–‹å§‹æŒ‘æˆ°</button>
            </div>
        </div>
    );
};

// ============ éŠæˆ²ç³»çµ± ============
const GamePage=()=>{
    const{isAuth,local,set}=useStore();
    const[state,setState]=useState('menu');
    const[scene,setScene]=useState(null);
    const[result,setResult]=useState(null);
    
    const player=isAuth?store.get().user:local;
    
    const scenarios=[
        {id:'S001',title:'ç¥ç§˜æŠ•è³‡',diff:'ç°¡å–®',desc:'æ”¶åˆ°è¨Šæ¯ï¼šã€Œå…§ç·šæ¶ˆæ¯ï¼ä¿è­‰å ±é…¬50%ï¼ã€',opts:[{id:'A',text:'ç«‹å³åŒ¯æ¬¾',ok:false,fb:'âŒã€Œä¿è­‰ç²åˆ©ã€æ˜¯è©é¨™è­¦è¨Šï¼'},{id:'B',text:'æŸ¥è­‰èº«ä»½',ok:true,fb:'âœ… æ­£ç¢ºï¼æ°¸é å…ˆæŸ¥è­‰ã€‚'}],reward:{exp:100,gold:50}},
        {id:'S002',title:'å‡å†’å®¢æœ',diff:'ç°¡å–®',desc:'ä¾†é›»ï¼šã€Œæˆ‘æ˜¯éŠ€è¡Œé¢¨æ§ï¼Œå¸³æˆ¶ç•°å¸¸ï¼Œè«‹æä¾›å¯†ç¢¼ã€‚ã€',opts:[{id:'A',text:'æä¾›å¯†ç¢¼',ok:false,fb:'âŒ éŠ€è¡Œçµ•ä¸è¦å¯†ç¢¼ï¼'},{id:'B',text:'æ’¥å®˜æ–¹é›»è©±',ok:true,fb:'âœ… æ­£ç¢ºï¼'}],reward:{exp:100,gold:50}},
        {id:'S003',title:'ç¶²è³¼è¶…ä½åƒ¹',diff:'ä¸­ç­‰',desc:'åç‰ŒåŒ…1/10åƒ¹ï¼Œè¦æ±‚ç§ä¸‹è½‰å¸³ã€‚',opts:[{id:'A',text:'è½‰å¸³è³¼è²·',ok:false,fb:'âŒ ç§ä¸‹è½‰å¸³ç„¡ä¿éšœï¼'},{id:'B',text:'ç”¨å¹³å°äº¤æ˜“',ok:true,fb:'âœ… ä½¿ç”¨æœ‰ä¿éšœçš„å¹³å°ã€‚'}],reward:{exp:150,gold:80}},
        {id:'S004',title:'ä¸­çé€šçŸ¥',diff:'ä¸­ç­‰',desc:'ç°¡è¨Šï¼šã€Œæ­å–œä¸­ç100è¬ï¼è«‹å…ˆåŒ¯æ‰‹çºŒè²»5è¬ã€‚ã€',opts:[{id:'A',text:'åŒ¯æ¬¾é ˜ç',ok:false,fb:'âŒ å…ˆä»˜è²»æ‰é ˜çæ˜¯è©é¨™ï¼'},{id:'B',text:'å¿½ç•¥åˆªé™¤',ok:true,fb:'âœ… æ­£ç¢ºï¼é€™æ˜¯å…¸å‹è©é¨™ã€‚'}],reward:{exp:150,gold:80}},
        {id:'S005',title:'æ„›æƒ…é™·é˜±',diff:'å›°é›£',desc:'ç¶²å‹äº¤å¾€3å€‹æœˆèªªæ€¥éœ€ç”¨éŒ¢ï¼Œè¦å€Ÿ10è¬ã€‚',opts:[{id:'A',text:'åŒ¯æ¬¾å¹«åŠ©',ok:false,fb:'âŒ ç¶²è·¯äº¤å‹å€ŸéŒ¢è¦å°å¿ƒï¼'},{id:'B',text:'è¦æ±‚è¦–è¨Š',ok:true,fb:'âœ… ç¢ºèªçœŸå¯¦èº«ä»½å¾ˆé‡è¦ï¼'}],reward:{exp:200,gold:100}},
    ];
    
    const play=(s)=>{setScene(s);setResult(null);setState('playing');};
    
    const answer=(o)=>{
        setResult(o);
        if(!isAuth){
            const nl={...local};
            if(o.ok){nl.exp+=scene.reward.exp;nl.gold+=scene.reward.gold;if(!nl.completed.includes(scene.id))nl.completed.push(scene.id);}
            else{nl.hp=Math.max(0,nl.hp-20);nl.exp+=20;}
            nl.level=Math.floor(nl.exp/300)+1;
            set({local:nl});
        }
    };
    
    if(state==='playing'&&scene){
        return(
            <div className="max-w-2xl mx-auto space-y-4">
                <button onClick={()=>setState('menu')} className="text-sm text-slate-400 hover:text-white">â† è¿”å›</button>
                <div className="card rounded-xl p-4 border border-slate-600">
                    <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center gap-2">
                            <span>ğŸ§™ Lv.{player?.level||1}</span>
                            <div className="w-20"><ProgressBar value={player?.hp||100} max={player?.maxHp||100} color="bg-red-500" h="h-1.5"/></div>
                        </div>
                        <div className="flex gap-3">
                            <span className="text-green-400">{player?.exp||0} EXP</span>
                            <span className="text-yellow-400">ğŸ’°{player?.gold||500}</span>
                        </div>
                    </div>
                </div>
                <div className="card rounded-xl p-5 border border-slate-600">
                    <div className="flex justify-between items-start mb-3">
                        <h2 className="text-xl font-bold">{scene.title}</h2>
                        <span className={`text-xs px-2 py-1 rounded ${scene.diff==='ç°¡å–®'?'bg-green-900 text-green-400':scene.diff==='ä¸­ç­‰'?'bg-yellow-900 text-yellow-400':'bg-red-900 text-red-400'}`}>{scene.diff}</span>
                    </div>
                    <div className="bg-slate-700/50 p-4 rounded-lg mb-4">
                        <p className="text-lg">{scene.desc}</p>
                    </div>
                    {!result?(
                        <div className="grid gap-3">
                            {scene.opts.map(o=>(
                                <button key={o.id} onClick={()=>answer(o)} className="p-4 rounded-lg border-2 border-slate-600 hover:border-blue-500 transition text-left">
                                    <span className="font-bold text-blue-400 mr-2">{o.id}.</span>{o.text}
                                </button>
                            ))}
                        </div>
                    ):(
                        <div className={`p-4 rounded-lg ${result.ok?'bg-green-900/40 border border-green-500 bounce':'bg-red-900/40 border border-red-500 shake'}`}>
                            <p className="font-bold text-lg mb-2">{result.fb}</p>
                            {result.ok?(
                                <p className="text-green-400">ç²å¾— +{scene.reward.exp} EXP, +{scene.reward.gold} é‡‘å¹£</p>
                            ):(
                                <p className="text-red-400">HP -20, ä½†ç²å¾— +20 EXP (å¾å¤±æ•—ä¸­å­¸ç¿’)</p>
                            )}
                            <button onClick={()=>setState('menu')} className="mt-3 px-6 py-2 bg-slate-600 rounded-lg">è¿”å›</button>
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    return(
        <div className="space-y-6">
            <h1 className="text-2xl font-bold">ğŸ® é˜²è©å†’éšª</h1>
            <div className="card rounded-xl p-4 border border-slate-600">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-2xl">ğŸ§™</div>
                        <div>
                            <div className="font-bold">Lv.{player?.level||1}</div>
                            <div className="w-24"><ProgressBar value={player?.hp||100} max={player?.maxHp||100} color="bg-red-500"/></div>
                        </div>
                    </div>
                    <div className="text-right text-sm">
                        <div className="text-green-400">{player?.exp||0} EXP</div>
                        <div className="text-yellow-400">ğŸ’° {player?.gold||500}</div>
                    </div>
                </div>
            </div>
            <div className="grid gap-4">
                {scenarios.map(s=>{
                    const done=local.completed.includes(s.id);
                    return(
                        <button key={s.id} onClick={()=>play(s)} className={`card rounded-xl p-4 border ${done?'border-green-500/50':'border-slate-600 hover:border-blue-500'} transition text-left`}>
                            <div className="flex justify-between items-start">
                                <div>
                                    <div className="flex items-center gap-2">
                                        {done&&<span className="text-green-400">âœ“</span>}
                                        <h3 className="font-bold">{s.title}</h3>
                                    </div>
                                    <p className="text-slate-400 text-sm mt-1">{s.desc.substring(0,30)}...</p>
                                </div>
                                <div className="text-right">
                                    <span className={`text-xs px-2 py-0.5 rounded ${s.diff==='ç°¡å–®'?'bg-green-900 text-green-400':s.diff==='ä¸­ç­‰'?'bg-yellow-900 text-yellow-400':'bg-red-900 text-red-400'}`}>{s.diff}</span>
                                    <div className="text-xs text-yellow-400 mt-1">+{s.reward.exp} EXP</div>
                                </div>
                            </div>
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

// ============ App ============
const App=()=>{
    const[page,setPage]=useState('home');
    return(
        <StoreProvider>
            <div className="min-h-screen pb-8">
                <Nav page={page} setPage={setPage}/>
                <main className="max-w-4xl mx-auto px-4 py-6">
                    {page==='home'&&<Home setPage={setPage}/>}
                    {page==='login'&&<AuthPage setPage={setPage}/>}
                    {page==='profile'&&<ProfilePage/>}
                    {page==='stats'&&<StatsPage/>}
                    {page==='edu'&&<EduPage/>}
                    {page==='game'&&<GamePage/>}
                </main>
                <footer className="text-center py-4 text-slate-500 text-xs">VE-System v9 | åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ | é“çš„1%åŸå‰‡</footer>
            </div>
        </StoreProvider>
    );
};

const StoreProvider=({children})=>{
    const[s,setS]=useState(store.get());
    useEffect(()=>store.sub(setS),[]);
    return<StoreContext.Provider value={{...s,set:store.set}}>{children}</StoreContext.Provider>;
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
